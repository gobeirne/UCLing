<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Rapid Pair — Code or QR (same payload)</title>
<style>
  :root{--muted:#666}
  body{margin:0;padding:16px;font:15px/1.4 system-ui,Segoe UI,Roboto,Arial;background:#f7f7f8;color:#222}
  h1{margin:0 0 10px;font-size:18px}
  .grid{display:grid;gap:12px;grid-template-columns:1fr}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  input,textarea{padding:6px;border:1px solid #ccc;border-radius:8px;font:inherit}
  input[type=number]{width:10ch}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9rem}
  .ok{background:#e8f5e9;color:#1b5e20}.warn{background:#fff8e1;color:#795548}.bad{background:#ffebee;color:#b71c1c}
  .muted{color:var(--muted);font-size:.9rem}
  #log{font:12px/1.35 ui-monospace,Menlo,Consolas,monospace;max-height:220px;overflow:auto;white-space:pre-wrap;border:1px solid #eee;border-radius:8px;padding:8px;background:#fafafa}
  #qrWrap{max-width:460px}
  .qr-nav{display:flex;gap:8px;align-items:center;margin-top:8px}
  #reader{width:320px;max-width:100%}
  .pill{padding:.2rem .6rem;border:1px solid #ccc;border-radius:999px;background:#fafafa}
  .section-title{margin:.2rem 0 .6rem;font-weight:600}
</style>
<!-- local libs placed alongside this file -->
<script src="qrcode.js"></script>
<script src="pako.min.js"></script>
<script src="html5-qrcode.min.js"></script>
</head>
<body>
<h1>Rapid Pair — Code or QR (same payload)</h1>

<div class="grid">
  <div class="card">
    <div class="section-title">Role</div>
    <div class="row">
      <button id="roleHost">Host</button>
      <button id="roleJoin">Joiner</button>
      <span id="roleBadge" class="status warn">no role</span>
    </div>
    <div class="section-title" style="margin-top:10px">Status</div>
    <div>Peer: <span id="conn" class="status warn">idle</span> &nbsp; DataChannel: <span id="dc" class="status warn">-</span></div>
    <div id="log" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <div class="section-title">Pick transport</div>
    <div class="row">
      <button id="modeCode">4/6-digit code</button>
      <button id="modeQR">QR</button>
      <span id="modeBadge" class="pill">none</span>
    </div>

    <!-- CODE MODE UI -->
    <div id="codeHost" style="display:none;margin-top:10px">
      <div class="section-title">Host — typed code</div>
      <div class="row">
        <button id="btnGenCode" disabled>Generate 4-digit code</button>
        <span class="muted">Falls back to 6 digits if needed.</span>
      </div>
      <div class="row" style="margin-top:8px">
        <div>Code: <span id="hostCode" class="pill">—</span></div>
        <div id="hostCodeHint" class="muted">Share this with the Joiner.</div>
      </div>
      <div class="muted" style="margin-top:8px">Waiting for the Joiner to enter the code… (polls Firestore every 1s)</div>
    </div>

    <div id="codeJoin" style="display:none;margin-top:10px">
      <div class="section-title">Joiner — typed code</div>
      <div class="row">
        <input id="joinCode" inputmode="numeric" placeholder="4 or 6 digits"/>
        <button id="btnUseCode" disabled>Connect</button>
      </div>
      <div class="muted" id="codeJoinHint" style="margin-top:6px">Ask the Host for the code, type it, and press Connect.</div>
    </div>

    <!-- QR MODE UI -->
    <div id="qrHost" style="display:none;margin-top:12px">
      <div class="section-title">Host — QR</div>
      <div class="row">
        <button id="btnGenQR" disabled>Generate QR</button>
        <button id="btnTrouble" disabled>Trouble scanning?</button>
      </div>
      <div id="qrWrap" style="margin-top:8px"></div>
      <div id="qrPager" class="qr-nav" style="display:none">
        <button id="qrPrev">◀ Prev</button>
        <span id="qrIndex"></span>
        <button id="qrNext">Next ▶</button>
      </div>
    </div>

    <div id="qrJoin" style="display:none;margin-top:12px">
      <div class="section-title">Joiner — QR</div>
      <div class="row">
        <button id="scanStart" disabled>Start Camera Scan</button>
        <button id="scanStop" disabled>Stop</button>
      </div>
      <div id="reader"></div>
      <textarea id="qrPaste" placeholder="(Optional) Paste scanned text…" style="width:100%;height:80px;margin-top:8px"></textarea>
      <div class="row" style="margin-top:6px"><button id="qrApply" disabled>Apply</button></div>
      <div id="qrProgress" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <div class="section-title">Actions (after connected)</div>
  <div class="row">
    <button id="btnBeep" disabled>Beep</button>
    <button id="btnChirp" disabled>Chirp</button>
    <button id="btnPing" disabled>Ping</button>
  </div>
</div>

<script type="module">
/* ------------------------- Tiny utils & logging ------------------------- */
const $=s=>document.querySelector(s), logEl=$('#log');
function log(...a){logEl.textContent+=a.join(' ')+"\n";logEl.scrollTop=logEl.scrollHeight;}
function badge(el,t,c){el.textContent=t;el.className='status '+c;}
function pill(el,t){el.textContent=t;}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
log('Ready. Pick Host/Joiner. Dense QR or typed code — both carry the same payload.');

let role=null, mode=null; // 'host'|'join', 'code'|'qr'

/* ------------------------- Base64url + packers ------------------------- */
function b64url(u8){ // no spread
  let bin=''; for(let i=0;i<u8.length;i++) bin+=String.fromCharCode(u8[i]);
  const b64=btoa(bin); let out='';
  for(let i=0;i<b64.length;i++){const ch=b64[i];
    if(ch==='+') out+='-'; else if(ch==='/') out+='_'; else if(ch==='='){} else out+=ch;
  } return out;
}
function unb64url(s){
  let b64=''; for(let i=0;i<s.length;i++){const ch=s[i];
    if(ch==='-') b64+='+'; else if(ch==='_') b64+='/'; else b64+=ch;
  } while(b64.length%4) b64+='=';
  const bin=atob(b64); const u8=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i); return u8;
}
function packJSON(o){ return b64url(pako.deflate(JSON.stringify(o))); }
function unpackJSON(s){ return JSON.parse(pako.inflate(unb64url(s), {to:'string'})); }

/* ------------------------- WebRTC boilerplate -------------------------- */
let pc=null, dc=null;
function newPC(){
  const cfg={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
  const p=new RTCPeerConnection(cfg);
  p.onicegatheringstatechange=()=>log('gathering:',p.iceGatheringState);
  p.oniceconnectionstatechange=()=>log('ice:',p.iceConnectionState);
  p.onsignalingstatechange=()=>log('signal:',p.signalingState);
  p.onconnectionstatechange=()=>{
    const s=p.connectionState; badge($('#conn'),s, s==='connected'?'ok':(s==='failed'||s==='disconnected'?'bad':'warn'));
    const up=s==='connected'; ['#btnBeep','#btnChirp','#btnPing'].forEach(id=>$(id).disabled=!up);
  };
  p.ondatachannel=e=>{ dc=e.channel; attachDC(); };
  return p;
}
function attachDC(){
  badge($('#dc'),dc.readyState, dc.readyState==='open'?'ok':'warn');
  dc.onopen =()=>badge($('#dc'),'open','ok');
  dc.onclose=()=>badge($('#dc'),'closed','bad');
  dc.onmessage=e=>log('RX', e.data);
}
function enableActions(){
  $('#btnBeep').onclick =()=>dc&&dc.readyState==='open'&&dc.send('BEEP');
  $('#btnChirp').onclick=()=>dc&&dc.readyState==='open'&&dc.send('CHIRP');
  $('#btnPing').onclick =()=>dc&&dc.readyState==='open'&&dc.send('PING');
}
enableActions();

/* Build our packed payloads (offer/answer) */
async function buildOfferPacked(){
  pc=newPC();
  dc=pc.createDataChannel('x'); attachDC();
  await pc.setLocalDescription(await pc.createOffer());
  // wait briefly for some ICE
  await Promise.race([
    new Promise(r=>pc.addEventListener('icegatheringstatechange',()=>pc.iceGatheringState==='complete'&&r(),{once:true})),
    sleep(1200)
  ]);
  return packJSON({v:1, kind:'offer', sdp:pc.localDescription.sdp});
}
async function buildAnswerPacked(remotePacked){
  const o=unpackJSON(remotePacked);
  if(o.kind!=='offer') throw new Error('expected offer');
  pc=newPC();
  await pc.setRemoteDescription({type:'offer', sdp:o.sdp});
  await pc.setLocalDescription(await pc.createAnswer());
  await Promise.race([
    new Promise(r=>pc.addEventListener('icegatheringstatechange',()=>pc.iceGatheringState==='complete'&&r(),{once:true})),
    sleep(1200)
  ]);
  return packJSON({v:1, kind:'answer', sdp:pc.localDescription.sdp});
}
async function applyAnswerPacked(ansPacked){
  const a=unpackJSON(ansPacked);
  if(a.kind!=='answer') throw new Error('expected answer');
  await pc.setRemoteDescription({type:'answer', sdp:a.sdp});
  log('Applied remote answer.');
}

/* ----------------------------- Firestore ------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const appFB=initializeApp({
  apiKey:"AIzaSyBZhqD0RE0miHDHhhlDZerGIsD0S5oy4Yw",
  authDomain:"ucpairing.firebaseapp.com",
  projectId:"ucpairing"
});
const db=getFirestore(appFB);

async function allocateCode(payload){
  // try 4-digit up to 20 attempts
  for(let i=0;i<20;i++){
    const code=(''+Math.floor(Math.random()*10000)).padStart(4,'0');
    const ref=doc(db,'pairs',code);
    const snap=await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{offer:payload, ts:Date.now()});
      return code;
    }
  }
  // fallback 6-digit
  while(true){
    const code=(''+Math.floor(Math.random()*1000000)).padStart(6,'0');
    const ref=doc(db,'pairs',code);
    const snap=await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{offer:payload, ts:Date.now()});
      return code;
    }
  }
}
async function readPair(code){
  const ref=doc(db,'pairs',code);
  const snap=await getDoc(ref);
  return snap.exists()?{ref, data:snap.data()}:null;
}

/* ----------------------- Code mode (typed code) ------------------------ */
let pollTimer=null, lastCode=null;

async function hostGenerateCode(){
  if(role!=='host'){ alert('Pick role Host first'); return; }
  $('#btnGenCode').disabled=true;
  try{
    const packed=await buildOfferPacked();
    log('Host: offer built & packed. Allocating code…');
    const code=await allocateCode(packed);
    lastCode=code;
    pill($('#hostCode'),code);
    $('#hostCodeHint').textContent='Waiting for Joiner…';
    // poll every 1s for answer
    clearInterval(pollTimer);
    pollTimer=setInterval(async ()=>{
      try{
        const res=await readPair(code);
        if(!res){ return; } // not written yet / already deleted
        const {ref, data}=res;
        if(data.answer){
          log('Host: answer seen in Firestore. Applying…');
          await applyAnswerPacked(data.answer);
          // cleanup the doc
          await deleteDoc(ref).catch(()=>{});
          clearInterval(pollTimer); pollTimer=null;
          $('#hostCodeHint').textContent='Connected (answer received).';
        }
      }catch(e){ log('Poll ERR', e.message||e); }
    },1000);
  }catch(e){
    log('Host code ERR', e.message||e);
  }finally{
    $('#btnGenCode').disabled=false;
  }
}

async function joinerUseCode(){
  if(role!=='join'){ alert('Pick Joiner first'); return; }
  const code=$('#joinCode').value.trim();
  if(!/^\d{4,6}$/.test(code)){ alert('Enter a 4 or 6 digit code'); return; }
  $('#btnUseCode').disabled=true;
  try{
    const res=await readPair(code);
    if(!res) throw new Error('Code not found (or expired)');
    const {ref, data}=res;
    if(!data.offer) throw new Error('No offer present');
    log('Joiner: got offer from Firestore, building answer…');
    const ansPacked=await buildAnswerPacked(data.offer);
    await setDoc(ref,{answer:ansPacked, ts:Date.now()},{merge:true});
    log('Joiner: wrote answer. Waiting for DTLS/ICE…');
  }catch(e){
    log('Joiner code ERR', e.message||e);
  }finally{
    $('#btnUseCode').disabled=false;
  }
}

/* --------------------------- QR mode (same payload) -------------------- */
const QR_PREFIX='UCP1|';
let qrPacked='', qrChunks=[], qrIdx=0, multi=false;

function renderQR(text, typeNum=0, ecLevel='L'){ // typeNum 0=auto; else fixed (e.g., 4, 6, 10…)
  const q=qrcode(typeNum, ecLevel); q.addData(text); q.make(); return q.createSvgTag(4);
}
function showDense(){
  try{
    $('#qrWrap').innerHTML=renderQR(qrPacked, 0, 'L');
    $('#qrPager').style.display='none';
    log(`Dense QR shown. Length: ${qrPacked.length}`);
  }catch(e){
    log('Dense render overflow; enabling chunk flow.');
    chunkifyV4or6();
  }
}
function chunkifyV4or6(){
  // chunk into up to 4 parts; each payload = PREFIX + total|index|data
  const maxPayloadV4 = 640 - (QR_PREFIX.length + '4|1|'.length); // approximate safety
  const parts=[];
  for(let i=0;i<qrPacked.length;i+=maxPayloadV4) parts.push(qrPacked.slice(i,i+maxPayloadV4));
  if(parts.length<=4){
    qrChunks=parts; multi=true; qrIdx=0; showChunk();
    return;
  }
  // fallback to V6 with a bit more headroom
  const maxPayloadV6 = 864 - (QR_PREFIX.length + '4|1|'.length);
  const parts6=[];
  for(let i=0;i<qrPacked.length;i+=maxPayloadV6) parts6.push(qrPacked.slice(i,i+maxPayloadV6));
  qrChunks=parts6.slice(0,4); // cap at 4
  multi=true; qrIdx=0; showChunk(6);
}
function showChunk(typeNum=4){
  const payload=`${QR_PREFIX}${qrChunks.length}|${qrIdx+1}|${qrChunks[qrIdx]}`;
  try{
    $('#qrWrap').innerHTML=renderQR(payload, typeNum, 'L');
    $('#qrIndex').textContent=`${qrIdx+1}/${qrChunks.length}`;
    $('#qrPager').style.display='flex';
  }catch(e){
    log(`Chunk render error: ${e.message||e}`);
  }
}
$('#qrPrev').onclick=()=>{ qrIdx=(qrIdx-1+qrChunks.length)%qrChunks.length; showChunk(); };
$('#qrNext').onclick=()=>{ qrIdx=(qrIdx+1)%qrChunks.length; showChunk(); };

async function hostGenerateQR(){
  if(role!=='host'){ alert('Pick role Host first'); return; }
  $('#btnGenQR').disabled=true; $('#btnTrouble').disabled=true;
  try{
    const packed=await buildOfferPacked();
    qrPacked=packJSON({via:'qr', kind:'offer', sdp:unpackJSON(packed).sdp}); // same content, marked
    showDense();
    $('#btnTrouble').disabled=false;
  }catch(e){
    log('Host QR ERR', e.message||e);
  }finally{
    $('#btnGenQR').disabled=false;
  }
}
$('#btnTrouble').onclick=()=>{
  if(!qrPacked){ log('No QR payload yet.'); return; }
  chunkifyV4or6();
};

/* Scanner & apply (QR) */
let scanner=null;
function resetAsm(){ asm={total:0, got:new Set(), parts:[]}; $('#qrProgress').textContent=''; }
let asm={total:0, got:new Set(), parts:[]};
function absorb(text){
  if(text.startsWith(QR_PREFIX)){
    const rest=text.slice(QR_PREFIX.length);
    const p1=rest.indexOf('|'), p2=rest.indexOf('|',p1+1);
    if(p1<0||p2<0) return;
    const total=+rest.slice(0,p1), index=+rest.slice(p1+1,p2), data=rest.slice(p2+1);
    if(!asm.total){ asm.total=total; asm.parts=Array(total).fill(''); }
    asm.got.add(index); asm.parts[index-1]=data;
    $('#qrProgress').textContent=`Got parts ${asm.got.size}/${asm.total}`;
    if(asm.got.size===asm.total){
      const joined=asm.parts.join(''); resetAsm(); applyPacked(joined);
    }
  }else{
    applyPacked(text);
  }
}
async function applyPacked(text){
  try{
    const obj=unpackJSON(text); // {via?, kind, sdp}
    if(role==='join' && obj.kind==='offer'){
      const ans=await buildAnswerPacked(packJSON({v:1,kind:'offer',sdp:obj.sdp}));
      // For QR path, show the joiner’s answer QR back to Host:
      qrPacked=packJSON({via:'qr', kind:'answer', sdp:unpackJSON(ans).sdp});
      $('#qrHost').style.display='block'; // reuse area to show reply
      $('#btnGenQR').disabled=true; // reply is ready, no need to generate
      $('#btnTrouble').disabled=false;
      showDense();
      log('QR: reply ready — show to Host.');
    }else if(role==='host' && obj.kind==='answer'){
      await applyAnswerPacked(packJSON({v:1,kind:'answer',sdp:obj.sdp}));
      log('QR: answer applied.');
    }else{
      log('QR role/kind mismatch. Ensure one is Host, the other Joiner.');
    }
  }catch(e){ log('QR apply ERR', e.message||e); }
}
$('#scanStart').onclick=()=>{
  try{
    scanner=new Html5Qrcode("reader");
    scanner.start({facingMode:"environment"},{fps:10,qrbox:240}, txt=>absorb(txt), _=>{})
      .catch(err=>log('scan ERR',err));
  }catch(e){ log('scanner init ERR', e.message||e); }
};
$('#scanStop').onclick=()=>{ scanner?.stop().then(()=>scanner.clear()).catch(()=>{}); scanner=null; };
$('#qrApply').onclick=()=>{ const t=$('#qrPaste').value.trim(); if(t){ absorb(t); $('#qrPaste').value=''; } };

/* ------------------------------- UI wiring ----------------------------- */
function setRole(r){
  role=r; badge($('#roleBadge'), r==='host'?'Host':'Joiner','ok');
  // Enable buttons depending on role & mode
  const isHost=r==='host', isJoin=r==='join';
  $('#btnGenCode').disabled=!isHost;
  $('#btnUseCode').disabled=!isJoin;
  $('#btnGenQR').disabled=!isHost;
  $('#btnTrouble').disabled=true;
  $('#scanStart').disabled=!isJoin;
  $('#scanStop').disabled=!isJoin;
  $('#qrApply').disabled=!isJoin;
}
function setMode(m){
  mode=m; pill($('#modeBadge'), m||'none');
  // toggle panels
  const showCode = m==='code', showQR = m==='qr';
  $('#codeHost').style.display = (showCode && role==='host')?'block':'none';
  $('#codeJoin').style.display = (showCode && role==='join')?'block':'none';
  $('#qrHost').style.display   = (showQR  && role==='host')?'block':'none';
  $('#qrJoin').style.display   = (showQR  && role==='join')?'block':'none';
}
$('#roleHost').onclick=()=>setRole('host');
$('#roleJoin').onclick=()=>setRole('join');
$('#modeCode').onclick=()=>setMode('code');
$('#modeQR').onclick =()=>setMode('qr');

$('#btnGenCode').onclick = hostGenerateCode;
$('#btnUseCode').onclick  = joinerUseCode;
$('#btnGenQR').onclick    = hostGenerateQR;
</script>
</body>
</html>