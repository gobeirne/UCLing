<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rapid Pair — LAN QR (v8)</title>
<style>
  body{margin:0;padding:16px;font:15px/1.4 system-ui;background:#fafafa;color:#222}
  h1{margin:0 0 12px;font-size:18px}
  .row{display:grid;gap:12px;grid-template-columns:1fr}
  @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  textarea{width:100%;height:110px;font:12px monospace}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9rem}
  .ok{background:#e8f5e9;color:#1b5e20} .warn{background:#fff8e1;color:#795548} .bad{background:#ffebee;color:#b71c1c}
  #log{font-size:.85rem;max-height:220px;overflow:auto;white-space:pre-wrap}
  #qrWrap svg{max-width:100%}
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
<h1>Rapid Pair — LAN QR <span class="status warn">v8</span></h1>

<div class="row">
  <div class="card">
    <h2>Role</h2>
    <button id="roleHost">Host</button>
    <button id="roleJoin">Joiner</button>
    <span id="roleBadge" class="status warn">no role</span>
  </div>
  <div class="card">
    <h2>Status</h2>
    <div>Peer: <span id="conn" class="status warn">idle</span> &nbsp; DataChannel: <span id="dc" class="status warn">-</span></div>
    <div id="log"></div>
  </div>
</div>

<div class="card">
  <h2>QR Flow (same LAN)</h2>
  <div class="row">
    <div class="card">
      <h3>My QR</h3>
      <button id="qrMake" disabled>Create my QR</button>
      <button id="qrTrouble" style="display:none;">⚠ Trouble scanning?</button>
      <label style="display:block;margin-top:6px"><input type="checkbox" id="robustECC"> Robust (ECC=M)</label>
      <div id="qrWrap" style="margin-top:8px"></div>
    </div>
    <div class="card">
      <h3>Scan partner QR</h3>
      <button id="scanStart" disabled>Start Scan</button>
      <button id="scanStop" disabled>Stop</button>
      <div id="reader" style="width:320px;max-width:100%;"></div>
      <textarea id="qrPaste" placeholder="Or paste payload…"></textarea>
      <button id="qrApply" disabled>Apply</button>
      <div id="qrProgress" class="muted" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Actions (after connected)</h2>
  <button id="btnBeep" disabled>Beep</button>
  <button id="btnChirp" disabled>Chirp</button>
  <button id="btnPing" disabled>Ping</button>
</div>

<script>
/* ===== Utilities ===== */
const $=s=>document.querySelector(s), logEl=$('#log');
function log(...a){ const line=a.join(' '); console.log('[LOG]', line); logEl.textContent+=line+"\n"; logEl.scrollTop=logEl.scrollHeight; }
function badge(el,t,c){ el.textContent=t; el.className='status '+c; }

function b64urlFromU8(u8){
  let bin=''; for(let i=0;i<u8.length;i++) bin+=String.fromCharCode(u8[i]);
  return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function u8FromB64url(s){
  const b64=s.replace(/-/g,'+').replace(/_/g,'/').padEnd(s.length+(4-s.length%4)%4,'=');
  const bin=atob(b64); const u8=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i); return u8;
}
function pack(o){ return 'RP8|'+b64urlFromU8(pako.deflate(JSON.stringify(o))); }
function unpack(s){ const u8=u8FromB64url(s.slice(4)); return JSON.parse(pako.inflate(u8,{to:'string'})); }

/* ===== WebRTC ===== */
let role=null, pc=null, dc=null, firstCand=null, packed='', splitMode=false;

function newPC(){
  const p=new RTCPeerConnection({iceServers:[]});
  p.oniceconnectionstatechange=()=>{ const s=p.iceConnectionState; log('ice:',s); badge($('#conn'),s,s==='connected'?'ok':(s==='failed'?'bad':'warn')); };
  p.onconnectionstatechange=()=>{ const s=p.connectionState; log('conn:',s); const up=s==='connected'; ['#btnBeep','#btnChirp','#btnPing'].forEach(id=>$(id).disabled=!up); };
  p.ondatachannel=e=>{dc=e.channel;attachDC();};
  p.onicecandidate=e=>{
    if(e.candidate && !firstCand && e.candidate.candidate.includes(' typ host ')){
      firstCand=e.candidate.candidate;
      log('Got first host candidate',firstCand);
      buildPayload();
    }
  };
  return p;
}
function attachDC(){ dc.onopen=()=>badge($('#dc'),'open','ok'); dc.onmessage=e=>log('RX',e.data); }
function send(m){ if(dc&&dc.readyState==='open'){dc.send(m);log('TX',m);} }

/* ===== Role UI ===== */
$('#roleHost').onclick=()=>{role='host';badge($('#roleBadge'),'Host','ok');enableUI();};
$('#roleJoin').onclick=()=>{role='join';badge($('#roleBadge'),'Joiner','ok');enableUI();};
function enableUI(){ $('#qrMake').disabled=false;$('#scanStart').disabled=false;$('#scanStop').disabled=false;$('#qrApply').disabled=false; }

/* ===== QR Rendering ===== */
function renderDenseQR(txt){
  const ecc=$('#robustECC').checked?'M':'L';
  const q=qrcode(0,ecc); q.addData(txt); q.make();
  $('#qrWrap').innerHTML=q.createSvgTag(6);
  $('#qrTrouble').style.display='inline';
}
function renderSplitQR(txt){
  const ecc=$('#robustECC').checked?'M':'L';
  const max=640; const total=Math.ceil(txt.length/max); let html='<div style="display:flex;gap:8px">';
  for(let i=0;i<total;i++){
    const chunk=txt.slice(i*max,(i+1)*max);
    const payload=`SPLIT|${i+1}/${total}|${chunk}`;
    const q=qrcode(4,ecc); q.addData(payload); q.make();
    html+=q.createSvgTag(6);
  }
  html+='</div>'; $('#qrWrap').innerHTML=html;
}
$('#qrTrouble').onclick=()=>{splitMode=true;renderSplitQR(packed);$('#qrTrouble').style.display='none';};

function buildPayload(){
  if(!role||!firstCand||!pc?.localDescription) return;
  const ufrag=/a=ice-ufrag:(\S+)/.exec(pc.localDescription.sdp)?.[1]||'uf';
  packed=pack({r:role[0],i:firstCand.split(' ')[4],p:firstCand.split(' ')[5],u:ufrag});
  splitMode=false; renderDenseQR(packed);
  log('QR ready. Payload length',packed.length);
}

/* ===== Create QR ===== */
$('#qrMake').onclick=async()=>{
  try{pc?.close();}catch{}
  pc=newPC();firstCand=null;packed='';
  if(role==='host'){dc=pc.createDataChannel('x');attachDC();await pc.setLocalDescription(await pc.createOffer());}
  else{log('Joiner: scan host QR first.');}
};

/* ===== Scanner ===== */
let html5=null,asm={};
function stopScanner(){ if(html5){html5.stop().then(()=>html5.clear()).catch(()=>{});html5=null;log('Scanner stopped');} }
$('#scanStart').onclick=()=>{html5=new Html5Qrcode("reader");html5.start({facingMode:"environment"},{fps:10,qrbox:240},txt=>absorb(txt),_=>{});};
$('#scanStop').onclick=stopScanner;
$('#qrApply').onclick=()=>{const t=$('#qrPaste').value.trim();if(t)absorb(t);};

function absorb(txt){
  if(txt.startsWith('SPLIT|')){
    const m=/SPLIT\|(\d+)\/(\d+)\|(.*)/.exec(txt);if(!m)return;
    const idx=+m[1],total=+m[2],data=m[3];
    if(!asm.total){asm.total=total;asm.parts=Array(total).fill('');}
    asm.parts[idx-1]=data;
    if(asm.parts.filter(x=>x).length===asm.total){const joined=asm.parts.join('');asm={};applyPacked(joined);}
  } else applyPacked(txt);
}

async function applyPacked(txt){
  try{const obj=unpack(txt);
    if(role==='join'&&obj.r==='h'){await pc.setRemoteDescription({type:'offer',sdp:dummySDP(obj)});await pc.setLocalDescription(await pc.createAnswer());log('Joiner applied offer, made answer');buildPayload();}
    else if(role==='host'&&obj.r==='j'){await pc.setRemoteDescription({type:'answer',sdp:dummySDP(obj)});log('Host applied answer');}
  }catch(e){log('ERR',e.message||e);}
}

/* ===== Dummy SDP builder from minimal info ===== */
function dummySDP(o){return `v=0
o=- 0 0 IN IP4 127.0.0.1
s=-
t=0 0
a=group:BUNDLE 0
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 0.0.0.0
a=ice-ufrag:${o.u}
a=ice-pwd:dummy123456
a=setup:${o.r==='h'?'actpass':'active'}
a=mid:0
a=sctp-port:5000
a=max-message-size:262144
a=candidate:0 1 udp 2122260223 ${o.i} ${o.p} typ host
a=end-of-candidates`;}

/* ===== Actions ===== */
$('#btnBeep').onclick=()=>send('BEEP');
$('#btnChirp').onclick=()=>send('CHIRP');
$('#btnPing').onclick=()=>send('PING');
</script>
</body>
</html>
