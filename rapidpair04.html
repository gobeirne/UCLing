<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rapid Pair — Minimal LAN QR v5</title>
<style>
  body{margin:0;padding:16px;font:15px/1.4 system-ui;background:#f7f7f8;color:#222}
  h1{margin:0 0 12px;font-size:18px}
  .row{display:grid;gap:12px;grid-template-columns:1fr}
  @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  textarea{width:100%;height:110px;font:12px monospace}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9rem}
  .ok{background:#e8f5e9;color:#1b5e20} .warn{background:#fff8e1;color:#795548} .bad{background:#ffebee;color:#b71c1c}
  #log{font-size:.85rem;max-height:220px;overflow:auto;white-space:pre-wrap}
  #qrWrap{max-width:280px}
</style>
<script src="qrcode.js"></script>
<script src="pako.min.js"></script>
<script src="html5-qrcode.min.js"></script>
</head>
<body>
<h1>Rapid Pair — Minimal LAN QR <span id="ver">v5.0</span></h1>

<div class="row">
  <div class="card">
    <h2>Role</h2>
    <button id="roleHost">Host</button>
    <button id="roleJoin">Joiner</button>
    <span id="roleBadge" class="status warn">no role</span>
  </div>
  <div class="card">
    <h2>Status</h2>
    <div>Peer: <span id="conn" class="status warn">idle</span> &nbsp; DataChannel: <span id="dc" class="status warn">-</span></div>
    <div id="log"></div>
  </div>
</div>

<div class="card">
  <h2>QR</h2>
  <div class="row">
    <div class="card">
      <h3>My QR</h3>
      <button id="qrMake" disabled>Create</button>
      <div id="qrWrap" style="margin-top:8px"></div>
    </div>
    <div class="card">
      <h3>Scan Partner</h3>
      <button id="scanStart" disabled>Start Scan</button>
      <button id="scanStop" disabled>Stop</button>
      <div id="reader" style="width:260px;max-width:100%;"></div>
      <textarea id="qrPaste" placeholder="Paste payload…"></textarea>
      <button id="qrApply" disabled>Apply</button>
    </div>
  </div>
</div>

<div class="card">
  <h2>Actions</h2>
  <button id="btnBeep" disabled>Beep</button>
  <button id="btnChirp" disabled>Chirp</button>
  <button id="btnPing" disabled>Ping</button>
</div>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), logEl=$('#log');
function log(...a){
  const msg=a.join(' ');
  logEl.textContent+=msg+"\\n";
  logEl.scrollTop=logEl.scrollHeight;
  console.log('[LOG]',...a);
}
function badge(el,t,c){el.textContent=t;el.className='status '+c;}

/* Safe base64url encode/decode */
function b64url(u8){
  let bin='';
  for(let i=0;i<u8.length;i++) bin+=String.fromCharCode(u8[i]);
  let b64=btoa(bin);
  b64=b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  return b64;
}
function unb64url(s){
  let b64=s.replace(/-/g,'+').replace(/_/g,'/');
  while(b64.length%4) b64+='=';
  const bin=atob(b64);
  const u8=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
  return u8;
}
function pack(o){
  const json=JSON.stringify(o);
  const def=pako.deflate(json);
  const out=b64url(def);
  console.log('[PACK]',o,'len',json.length,'→',out.length);
  return out;
}
function unpack(s){
  const out=JSON.parse(pako.inflate(unb64url(s),{to:'string'}));
  console.log('[UNPACK]',out);
  return out;
}

/* ===== Role ===== */
let role=null;
function setRole(r){
  role=r;
  badge($('#roleBadge'),r,'ok');
  $('#qrMake').disabled=(r==='join');
  $('#scanStart').disabled=false; $('#scanStop').disabled=false; $('#qrApply').disabled=false;
  log('Role set',r);
}
$('#roleHost').onclick=()=>setRole('host');
$('#roleJoin').onclick=()=>setRole('join');

/* ===== WebRTC ===== */
let pc,dc,scanner=null;
function newPC(){
  const p=new RTCPeerConnection({iceServers:[]});
  p.onconnectionstatechange=()=>{
    const s=p.connectionState;
    badge($('#conn'),s,s==='connected'?'ok':'warn');
    const up=s==='connected';
    ['#btnBeep','#btnChirp','#btnPing'].forEach(id=>$(id).disabled=!up);
    console.log('[STATE]',s);
  };
  p.ondatachannel=e=>{dc=e.channel;attachDC();};
  return p;
}
function attachDC(){
  badge($('#dc'),dc.readyState,dc.readyState==='open'?'ok':'warn');
  dc.onopen=()=>{badge($('#dc'),'open','ok');console.log('[DC] open');};
  dc.onmessage=e=>{log('RX',e.data);};
}
function send(m){if(dc&&dc.readyState==='open'){dc.send(m);console.log('[TX]',m);}}
$('#btnBeep').onclick=()=>send('BEEP');
$('#btnChirp').onclick=()=>send('CHIRP');
$('#btnPing').onclick=()=>send('PING');

/* ===== SDP builder ===== */
function parseCandidate(c){
  const parts=c.trim().split(/\\s+/);
  return {ip:parts[4],port:parseInt(parts[5],10)};
}
function buildSDP(type,ip,port,ufrag){
  return `v=0
o=- 0 0 IN IP4 127.0.0.1
s=-
t=0 0
a=group:BUNDLE 0
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 0.0.0.0
a=ice-ufrag:${ufrag}
a=ice-pwd:dummyICEpwd123
a=ice-options:trickle
a=fingerprint:sha-256 00:11:22:33:44:55:66:77:88:99:AA:BB:CC:DD:EE:FF:00:11:22:33:44:55:66:77:88:99:AA:BB:CC:DD:EE:FF
a=setup:${type==='offer'?'actpass':'active'}
a=mid:0
a=sctp-port:5000
a=max-message-size:262144
a=candidate:0 1 udp 2122252543 ${ip} ${port} typ host
a=end-of-candidates`;
}

/* ===== QR ===== */
function renderQR(txt){const q=qrcode(0,'M');q.addData(txt);q.make();return q.createSvgTag(6);}
function showQR(p){$('#qrWrap').innerHTML=renderQR(p);console.log('[QR]',p.length,'chars');}
function stopScanner(){if(scanner){scanner.stop().then(()=>scanner.clear()).catch(()=>{});scanner=null;$('#scanStop').disabled=true;}}
function absorb(txt){stopScanner();applyPacked(txt);}

/* ===== Flow ===== */
$('#qrMake').onclick=async()=>{
  pc=newPC();dc=pc.createDataChannel('x');attachDC();
  let sent=false;
  pc.onicecandidate=e=>{
    if(sent||!e.candidate)return;
    const c=e.candidate.candidate;
    if(/ typ host/.test(c)){
      const {ip,port}=parseCandidate(c);
      const ufrag=pc.localDescription.sdp.match(/a=ice-ufrag:(.+)/)[1];
      const payload={r:'h',t:'o',i:ip,p:port,u:ufrag};
      const packed=pack(payload);showQR(packed);log('Host QR ready');sent=true;
    }
  };
  await pc.setLocalDescription(await pc.createOffer());
};
async function onGotHost(o){
  pc=newPC();
  const offer=buildSDP('offer',o.i,o.p,o.u);
  await pc.setRemoteDescription({type:'offer',sdp:offer});
  await pc.setLocalDescription(await pc.createAnswer());
  let sent=false;
  pc.onicecandidate=e=>{
    if(sent||!e.candidate)return;
    const c=e.candidate.candidate;
    if(/ typ host/.test(c)){
      const {ip,port}=parseCandidate(c);
      const ufrag=pc.localDescription.sdp.match(/a=ice-ufrag:(.+)/)[1];
      const payload={r:'j',t:'a',i:ip,p:port,u:ufrag};
      const packed=pack(payload);showQR(packed);log('Joiner QR ready');sent=true;
    }
  };
}
async function onGotJoin(o){
  const ans=buildSDP('answer',o.i,o.p,o.u);
  await pc.setRemoteDescription({type:'answer',sdp:ans});
  log('Host applied Answer');
}
function applyPacked(p){
  try{
    const o=unpack(p);
    if(o.t==='o'&&o.r==='h'&&role==='join'){onGotHost(o);}
    else if(o.t==='a'&&o.r==='j'&&role==='host'){onGotJoin(o);}
    else log('Mismatch');
  }catch(e){log('ERR',e);}
}

/* ===== Scanner ===== */
$('#scanStart').onclick=()=>{
  scanner=new Html5Qrcode("reader");
  scanner.start({facingMode:"environment"},{fps:10,qrbox:240},txt=>absorb(txt),_=>{})
    .then(()=>{$('#scanStop').disabled=false;});
};
$('#scanStop').onclick=()=>stopScanner();
$('#qrApply').onclick=()=>{const t=$('#qrPaste').value.trim();if(t)absorb(t);};

/* ===== Init ===== */
window.addEventListener('load',()=>log('Ready. Pick Host or Joiner.'));
</script>
</body>
</html>
