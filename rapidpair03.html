<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rapid Pair — Minimal LAN QR</title>
<style>
  body{margin:0;padding:16px;font:15px/1.4 system-ui;background:#f7f7f8;color:#222}
  h1{margin:0 0 12px;font-size:18px}
  .row{display:grid;gap:12px;grid-template-columns:1fr}
  @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  input,textarea{padding:6px;border:1px solid #ccc;border-radius:8px}
  textarea{width:100%;height:110px;font:12px monospace}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9rem}
  .ok{background:#e8f5e9;color:#1b5e20} .warn{background:#fff8e1;color:#795548} .bad{background:#ffebee;color:#b71c1c}
  #log{font-size:.85rem;max-height:220px;overflow:auto;white-space:pre-wrap}
  #qrWrap{max-width:320px}
  #ver{color:#666;font-size:.8rem}
  .muted{color:#666;font-size:.9rem}
</style>
<!-- local libs -->
<script src="qrcode.js"></script>
<script src="pako.min.js"></script>
<script src="html5-qrcode.min.js"></script>
</head>
<body>
<h1>Rapid Pair — Minimal LAN QR <span id="ver">v4.0</span></h1>

<div class="row">
  <div class="card">
    <h2>Role</h2>
    <button id="roleHost">Host</button>
    <button id="roleJoin">Joiner</button>
    <span id="roleBadge" class="status warn">no role</span>
    <div class="muted">Flow: Host shows QR → Joiner scans & shows reply → Host scans reply. LAN only.</div>
  </div>
  <div class="card">
    <h2>Status</h2>
    <div>Peer: <span id="conn" class="status warn">idle</span> &nbsp; DataChannel: <span id="dc" class="status warn">-</span></div>
    <div id="log"></div>
  </div>
</div>

<div class="card">
  <h2>QR (offline)</h2>
  <div class="row">
    <div class="card">
      <h3>Make & show my QR</h3>
      <button id="qrMake" disabled>Create my QR</button>
      <div id="qrWrap" style="margin-top:8px"></div>
    </div>
    <div class="card">
      <h3>Scan partner QR</h3>
      <button id="scanStart" disabled>Start Camera Scan</button>
      <button id="scanStop" disabled>Stop</button>
      <div id="reader" style="width:280px;max-width:100%;"></div>
      <textarea id="qrPaste" placeholder="Paste scanned text…"></textarea>
      <button id="qrApply" disabled>Apply</button>
    </div>
  </div>
</div>

<div class="card">
  <h2>Actions</h2>
  <button id="btnBeep" disabled>Beep</button>
  <button id="btnChirp" disabled>Chirp</button>
  <button id="btnPing" disabled>Ping</button>
</div>

<script>
/* ====== Helpers ====== */
const $=s=>document.querySelector(s), logEl=$('#log');
function log(...a){logEl.textContent+=a.join(' ')+"\n";logEl.scrollTop=logEl.scrollHeight;}
function badge(el,t,c){el.textContent=t;el.className='status '+c;}
function b64url(u8){let bin='';for(let i=0;i<u8.length;i++)bin+=String.fromCharCode(u8[i]);const b64=btoa(bin);let out='';for(let i=0;i<b64.length;i++){const ch=b64[i];if(ch==='+')out+='-';else if(ch==='/')out+='_';else if(ch==='='){}else out+=ch;}return out;}
function unb64url(s){let b64='';for(let i=0;i<s.length;i++){const ch=s[i];if(ch==='-')b64+='+';else if(ch==='_')b64+='/';else b64+=ch;}while(b64.length%4)b64+='=';const bin=atob(b64);const u8=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)u8[i]=bin.charCodeAt(i);return u8;}
function pack(o){return b64url(pako.deflate(JSON.stringify(o)));}
function unpack(s){return JSON.parse(pako.inflate(unb64url(s),{to:'string'}));}

/* ====== Role ====== */
let role=null;
function setRole(r){
  role=r; badge($('#roleBadge'), r==='host'?'Host':'Joiner','ok');
  $('#qrMake').disabled=(r==='join'); // joiner creates QR after scanning host
  $('#scanStart').disabled=false; $('#scanStop').disabled=false; $('#qrApply').disabled=false;
}
$('#roleHost').onclick=()=>setRole('host');
$('#roleJoin').onclick=()=>setRole('join');

/* ====== WebRTC ====== */
let pc,dc,scanner=null;
function newPC(){
  const p=new RTCPeerConnection({iceServers:[]});
  p.oniceconnectionstatechange=()=>log('ice:',p.iceConnectionState);
  p.onsignalingstatechange=()=>log('signal:',p.signalingState);
  p.onconnectionstatechange=()=>{
    const s=p.connectionState; badge($('#conn'),s, s==='connected'?'ok':(s==='failed'||s==='disconnected'?'bad':'warn'));
    const up=s==='connected'; ['#btnBeep','#btnChirp','#btnPing'].forEach(id=>$(id).disabled=!up);
  };
  p.ondatachannel=e=>{dc=e.channel;attachDC();};
  return p;
}
function attachDC(){badge($('#dc'),dc.readyState,dc.readyState==='open'?'ok':'warn');dc.onopen=()=>badge($('#dc'),'open','ok');dc.onclose=()=>badge($('#dc'),'closed','bad');dc.onmessage=e=>log('RX',e.data);}
function send(m){if(dc&&dc.readyState==='open')dc.send(m);}
$('#btnBeep').onclick=()=>send('BEEP');
$('#btnChirp').onclick=()=>send('CHIRP');
$('#btnPing').onclick=()=>send('PING');

/* ====== Minimal SDP helpers ====== */
function getLineValue(sdp,prefix){
  const line = sdp.split(/\r?\n/).find(l=>l.startsWith(prefix));
  return line ? line.substring(prefix.length) : null;
}
function parseHostCandidate(candidateStr){
  // a=candidate:... <component-id> <transport> <priority> <ip> <port> typ host ...
  const parts = candidateStr.trim().split(/\s+/);
  return {ip: parts[4], port: parseInt(parts[5],10)};
}
function extractParamsFrom(ld, candStr){
  const {ip,port}=parseHostCandidate(candStr);
  const sdp=ld.sdp;
  const ufrag=getLineValue(sdp,'a=ice-ufrag:');
  const pwd=getLineValue(sdp,'a=ice-pwd:');
  const fpLine=getLineValue(sdp,'a=fingerprint:'); // e.g. "sha-256 XX:YY:.."
  const fingerprint = fpLine ? fpLine.split(' ')[1] : null;
  if(!ip||!port||!ufrag||!pwd||!fingerprint){ throw new Error('missing params for QR'); }
  return {ip,port,ufrag,pwd,fingerprint};
}
function buildSDP(type, ip, port, ufrag, pwd, fingerprint){
  return `v=0
o=- 0 0 IN IP4 127.0.0.1
s=-
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 0.0.0.0
a=ice-ufrag:${ufrag}
a=ice-pwd:${pwd}
a=ice-options:trickle
a=fingerprint:sha-256 ${fingerprint}
a=setup:${type==='offer'?'actpass':'active'}
a=mid:0
a=sctp-port:5000
a=max-message-size:262144
a=candidate:0 1 udp 2122252543 ${ip} ${port} typ host
a=end-of-candidates`;
}

/* ====== QR handling ====== */
function renderQR(txt){
  const ecc='M';
  const q=qrcode(0,ecc); q.addData(txt); q.make();
  return q.createSvgTag(6); // chunky version 2–3
}
function showQR(packed){ $('#qrWrap').innerHTML=renderQR(packed); }
function stopScanner(){ if(scanner){ scanner.stop().then(()=>scanner.clear()).catch(()=>{}); scanner=null; $('#scanStop').disabled=true; } }
function absorb(txt){ stopScanner(); applyPacked(txt); }

/* ====== Flow ====== */
$('#qrMake').onclick=async()=>{
  if(role!=='host'){ alert('Pick Host first'); return; }
  pc=newPC(); dc=pc.createDataChannel('x'); attachDC();
  let sent=false;
  pc.onicecandidate=e=>{
    if(sent||!e.candidate) return;
    const c = e.candidate.candidate || '';
    if(/ typ host/.test(c)){
      try{
        const params=extractParamsFrom(pc.localDescription, c);
        const payload={role:'host',t:'offer',...params};
        const packed=pack(payload); showQR(packed); log('Host QR ready.');
        sent=true;
      }catch(err){ log('ERR making host QR:', err.message||err); }
    }
  };
  await pc.setLocalDescription(await pc.createOffer());
};

async function onGotHost(obj){
  pc=newPC();
  const offer=buildSDP('offer',obj.ip,obj.port,obj.ufrag,obj.pwd,obj.fingerprint);
  await pc.setRemoteDescription({type:'offer',sdp:offer});
  await pc.setLocalDescription(await pc.createAnswer());
  let sent=false;
  pc.onicecandidate=e=>{
    if(sent||!e.candidate) return;
    const c = e.candidate.candidate || '';
    if(/ typ host/.test(c)){
      try{
        const params=extractParamsFrom(pc.localDescription, c);
        const payload={role:'join',t:'answer',...params};
        const packed=pack(payload); showQR(packed); log('Joiner QR ready.');
        sent=true;
      }catch(err){ log('ERR making joiner QR:', err.message||err); }
    }
  };
}

async function onGotJoin(obj){
  const answer=buildSDP('answer',obj.ip,obj.port,obj.ufrag,obj.pwd,obj.fingerprint);
  await pc.setRemoteDescription({type:'answer',sdp:answer});
  log('Host applied Answer.');
}

function applyPacked(packed){
  try{
    const obj=unpack(packed);
    if(obj.t==='offer'&&obj.role==='host'&&role==='join'){ onGotHost(obj); }
    else if(obj.t==='answer'&&obj.role==='join'&&role==='host'){ onGotJoin(obj); }
    else { log('Role/step mismatch.'); }
  }catch(e){ log('ERR applyPacked:', e.message||e); }
}

/* ====== Scanner controls ====== */
$('#scanStart').onclick=()=>{
  scanner=new Html5Qrcode("reader");
  scanner.start({facingMode:"environment"},{fps:10,qrbox:240},txt=>absorb(txt),_=>{})
    .then(()=>{$('#scanStop').disabled=false;})
    .catch(err=>log('scan start ERR',err));
};
$('#scanStop').onclick=()=>stopScanner();
$('#qrApply').onclick=()=>{ const t=$('#qrPaste').value.trim(); if(t) absorb(t); };

/* ====== Init ====== */
window.addEventListener('load',()=>{ log('Ready. Pick Host or Joiner.'); });
</script>
</body>
</html>
