<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pairing Demo — 6-Digit Cloud + QR Offline</title>
<style>
  /* ... same CSS as before ... */
</style>
</head>
<body>
<h1>Pairing Demo — 6-Digit Cloud + QR Offline</h1>

<div class="row">
  <div class="card">
    <h2>Role</h2>
    <button id="roleHost">Host</button>
    <button id="roleJoin">Joiner</button>
    <span id="roleBadge" class="status warn">no role</span>
  </div>
  <div class="card">
    <h2>Status</h2>
    <div>Peer: <span id="conn" class="status warn">idle</span> &nbsp; DataChannel: <span id="dc" class="status warn">-</span></div>
    <div id="log" class="muted" style="margin-top:8px;max-height:180px;overflow:auto;white-space:pre-wrap"></div>
  </div>
</div>

<div class="card">
  <h2>Cloud (6-digit)</h2>
  <div style="display:flex;gap:8px;align-items:center">
    <label>Code:&nbsp;<input id="code" inputmode="numeric" maxlength="6" style="width:9ch"/></label>
    <button id="startCloud">Start</button>
    <button id="btnReset">Reset Room</button>
  </div>
</div>

<!-- QR UI same as before ... -->

<div class="card">
  <h2>Actions</h2>
  <div class="controls">
    <button id="btnBeep" disabled>Beep</button>
    <button id="btnChirp" disabled>Chirp</button>
    <button id="btnPing" disabled>Ping</button>
  </div>
</div>

<script type="module">
/* ==== helpers/logging ==== */
const $=s=>document.querySelector(s), logEl=$('#log');
function log(...a){logEl.textContent+=a.join(' ')+"\\n";logEl.scrollTop=logEl.scrollHeight;}
function badge(el,t,c){el.textContent=t;el.className='status '+c;}
function sixDigits(x){return(''+x).replace(/\\D/g,'').slice(0,6).padStart(6,'0');}

/* ==== role ==== */
let role=null;
$('#roleHost').onclick=()=>{role='host';badge($('#roleBadge'),'Host','ok');};
$('#roleJoin').onclick=()=>{role='join';badge($('#roleBadge'),'Joiner','ok');};

/* ==== audio (unchanged) ==== */
// beep(), chirp() as before...

/* ==== WebRTC setup (unchanged except refactor) ==== */
let pc,dc,roomUnsub=null,callerUnsub=null,calleeUnsub=null;
function newPC(localOnly){ /* same as before */ }
function attachDC(){ /* same as before */ }
function send(m){ if(dc&&dc.readyState==='open') dc.send(JSON.stringify(m)); }
$('#btnBeep').onclick=()=>send({type:'BEEP'});
$('#btnChirp').onclick=()=>send({type:'CHIRP'});
$('#btnPing').onclick=()=>send({type:'PING'});

/* ==== Firebase auto-init ==== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {
  initializeFirestore, doc, setDoc, onSnapshot, updateDoc, Timestamp,
  collection, addDoc, getDocs, deleteDoc, deleteField
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig={ /* ... your keys ... */ };
const app=initializeApp(firebaseConfig);
const db=initializeFirestore(app,{experimentalAutoDetectLongPolling:true,useFetchStreams:false});
log('Firebase ready');

/* ==== Cloud start (refactored) ==== */
async function startCloudWith(code){
  if(!role){alert('Pick role first');return;}
  const roomRef=doc(db,'rooms',code);
  const expiresAt=Timestamp.fromMillis(Date.now()+7*24*60*60*1000);
  localStorage.setItem('pair.role', role);
  localStorage.setItem('pair.code', code);

  roomUnsub&&roomUnsub(); callerUnsub&&callerUnsub(); calleeUnsub&&calleeUnsub();
  newPC(false);

  if(role==='host'){
    dc=pc.createDataChannel('ucktt'); attachDC();
    const callerCandidates=collection(roomRef,'callerCandidates');
    const calleeCandidates=collection(roomRef,'calleeCandidates');
    pc.onicecandidate=async e=>{if(e.candidate)await addDoc(callerCandidates,e.candidate.toJSON());};
    const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
    await setDoc(roomRef,{offer,expiresAt},{merge:true});
    roomUnsub=onSnapshot(roomRef,async s=>{
      const d=s.data()||{};
      if(d.answer&&!pc.currentRemoteDescription){await pc.setRemoteDescription(d.answer); log('Got answer');}
    });
    calleeUnsub=onSnapshot(calleeCandidates,snap=>{
      snap.docChanges().forEach(ch=>{if(ch.type==='added')pc.addIceCandidate(ch.doc.data());});
    });
  } else {
    const callerCandidates=collection(roomRef,'callerCandidates');
    const calleeCandidates=collection(roomRef,'calleeCandidates');
    pc.onicecandidate=async e=>{if(e.candidate)await addDoc(calleeCandidates,e.candidate.toJSON());};
    roomUnsub=onSnapshot(roomRef,async s=>{
      const d=s.data()||{};
      if(d.offer&&!pc.currentRemoteDescription){
        await pc.setRemoteDescription(d.offer);
        const ans=await pc.createAnswer(); await pc.setLocalDescription(ans);
        await updateDoc(roomRef,{answer:ans,expiresAt});
        log('Posted answer');
        callerUnsub=onSnapshot(callerCandidates,snap=>{
          snap.docChanges().forEach(ch=>{if(ch.type==='added')pc.addIceCandidate(ch.doc.data());});
        });
      }
    });
  }
}

/* ==== Reset Room ==== */
async function clearRoom(code){
  const roomRef=doc(db,'rooms',code);
  const caller=await getDocs(collection(roomRef,'callerCandidates'));
  const callee=await getDocs(collection(roomRef,'calleeCandidates'));
  await Promise.all([
    ...caller.docs.map(d=>deleteDoc(d.ref)),
    ...callee.docs.map(d=>deleteDoc(d.ref)),
    updateDoc(roomRef,{offer:deleteField(),answer:deleteField()}).catch(()=>{})
  ]);
  log('Room cleared');
}
$('#btnReset').onclick=async()=>{
  const code=$('#code').value.trim();
  if(!code)return;
  try{pc?.close();}catch{}
  await clearRoom(code);
  await startCloudWith(code);
};

/* ==== Button start ==== */
$('#startCloud').onclick=async()=>{
  const code=sixDigits($('#code').value||Math.floor(Math.random()*1e6));
  $('#code').value=code;
  await startCloudWith(code);
};

/* ==== Auto-rejoin ==== */
window.addEventListener('load',()=>{
  const lastRole=localStorage.getItem('pair.role');
  const lastCode=localStorage.getItem('pair.code');
  if(lastRole&&lastCode){
    role=lastRole; badge($('#roleBadge'), role==='host'?'Host':'Joiner','ok');
    $('#code').value=lastCode;
    startCloudWith(lastCode);
  }
});
</script>
</body>
</html>
