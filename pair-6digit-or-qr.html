<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pairing Demo â€” Cloud (STUN) + QR (Offline LAN)</title>
<style>
  :root{--bg:#f7f7f8;--fg:#222;--muted:#666;--ok:#1b5e20;--okbg:#e8f5e9;--warn:#795548;--warnbg:#fff8e1;--bad:#b71c1c;--badbg:#ffebee}
  body{margin:0;padding:16px;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  h1{margin:0 0 12px;font-size:18px}
  .row{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
  .muted{color:var(--muted);font-size:.9rem}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  input,textarea{padding:6px;border:1px solid #ccc;border-radius:8px}
  textarea{width:100%;height:110px;font:12px ui-monospace,monospace}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9rem}
  .ok{background:var(--okbg);color:var(--ok)} .warn{background:var(--warnbg);color:var(--warn)} .bad{background:var(--badbg);color:var(--bad)}
  #log{font-size:.86rem;max-height:190px;overflow:auto;white-space:pre-wrap}
  #qrWrap svg{width:280px;height:280px}
  .qr-nav{display:flex;gap:8px;align-items:center}
  #randCode{display:none;} /* only visible for Host */
</style>

<script src="qrcode.js"></script>
<script src="pako.min.js"></script>
<script src="html5-qrcode.min.js"></script>
</head>
<body>
<h1>Pairing Demo â€” Cloud (STUN) + QR (Offline LAN)</h1>

<div class="row">
  <div class="card">
    <h2>Role</h2>
    <button id="roleHost">Host</button>
    <button id="roleJoin">Joiner</button>
    <span id="roleBadge" class="status warn">no role</span>
  </div>
  <div class="card">
    <h2>Status</h2>
    <div>Peer: <span id="conn" class="status warn">idle</span> &nbsp; DataChannel: <span id="dc" class="status warn">-</span></div>
    <div id="log" class="muted"></div>
  </div>
</div>

<div class="card">
  <h2>Cloud (6-digit)</h2>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <label>Code: <input id="code" inputmode="numeric" maxlength="6" style="width:9ch"/></label>
    <button id="randCode">ðŸŽ² Random</button>
    <button id="startCloud">Start</button>
    <button id="resetRoom">Reset</button>
  </div>
</div>

<div class="card">
  <h2>QR (offline LAN)</h2>
  <div class="row">
    <div class="card">
      <h3>Make & show my QR</h3>
      <button id="qrMake">Create my QR</button>
      <button id="qrToggle" style="display:none;">âš  Trouble scanning?</button>
      <div id="qrWrap"></div>
      <div id="qrNav" class="qr-nav" style="display:none;">
        <button id="qrPrev">â—€ Prev</button>
        <span id="qrIndex" class="muted">0/0</span>
        <button id="qrNext">Next â–¶</button>
      </div>
    </div>
    <div class="card">
      <h3>Scan partner QR</h3>
      <button id="scanStart">Start Camera Scan</button>
      <button id="scanStop">Stop</button>
      <div id="reader" style="width:320px;max-width:100%;"></div>
      <textarea id="qrPaste" placeholder="Paste scanned textâ€¦"></textarea>
      <button id="qrApply">Apply</button>
      <div id="qrProgress" class="muted"></div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Actions</h2>
  <button id="btnBeep" disabled>Beep</button>
  <button id="btnChirp" disabled>Chirp</button>
  <button id="btnPing" disabled>Ping</button>
</div>

<script type="module">
const $=s=>document.querySelector(s), logEl=$('#log');
function log(...a){const line=a.join(' ');console.log(line);logEl.textContent+=line+"\\n";logEl.scrollTop=logEl.scrollHeight;}
function badge(el,t,c){el.textContent=t;el.className='status '+c;}
function sixDigits(x){return(''+x).replace(/\\D/g,'').slice(0,6).padStart(6,'0');}
function b64urlFromBytes(u8){return btoa(String.fromCharCode(...u8)).replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=+$/,'');}
function bytesFromB64url(s){s=s.replace(/-/g,'+').replace(/_/g,'/');while(s.length%4)s+='=';const bin=atob(s);const u8=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)u8[i]=bin.charCodeAt(i);return u8;}
function pack(obj){const json=JSON.stringify(obj).replace(/\\r?\\n/g,'\\\\n');const def=pako.deflate(json);return b64urlFromBytes(def);}
function unpack(s){const bytes=bytesFromB64url(s);const str=pako.inflate(bytes,{to:'string'});return JSON.parse(str);}

/* Role logic */
let role=null;
function onRoleChange(newRole){
  role=newRole;
  badge($('#roleBadge'), role==='host'?'Host':'Joiner','ok');
  $('#randCode').style.display = role==='host' ? 'inline' : 'none';
  $('#qrMake').disabled = role!=='host';
  $('#qrToggle').disabled = role!=='host';
  $('#scanStart').disabled = role!=='join';
  $('#scanStop').disabled  = role!=='join';
  $('#qrPaste').disabled   = role!=='join';
  $('#qrApply').disabled   = role!=='join';
}
$('#roleHost').onclick=()=>onRoleChange('host');
$('#roleJoin').onclick=()=>onRoleChange('join');

/* WebRTC core */
let pc,dc;
function newPCCloud(){return new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});}
function newPCLocal(){return new RTCPeerConnection({iceServers:[]});}
async function waitIceComplete(pcx){if(pcx.iceGatheringState==='complete')return;await new Promise(res=>pcx.addEventListener('icegatheringstatechange',()=>pcx.iceGatheringState==='complete'&&res()));}
function attachPCHandlers(){pc.onconnectionstatechange=()=>{const st=pc.connectionState;badge($('#conn'),st,st==='connected'?'ok':(st==='failed'?'bad':'warn'));['#btnBeep','#btnChirp','#btnPing'].forEach(id=>$(id).disabled=st!=='connected');};pc.ondatachannel=e=>{dc=e.channel;attachDC();};}
function attachDC(){badge($('#dc'),dc.readyState,dc.readyState==='open'?'ok':'warn');dc.onopen=()=>badge($('#dc'),dc.readyState,'ok');dc.onclose=()=>badge($('#dc'),dc.readyState,'bad');dc.onmessage=e=>log('RX',e.data);}
function send(m){if(dc&&dc.readyState==='open')dc.send(m);}
$('#btnBeep').onclick=()=>send('BEEP');$('#btnChirp').onclick=()=>send('CHIRP');$('#btnPing').onclick=()=>send('PING');

/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { initializeFirestore, doc, setDoc, onSnapshot, updateDoc, Timestamp, deleteField } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
const app = initializeApp({ apiKey:"AIzaSyBZhqD0RE0miHDHhhlDZerGIsD0S5oy4Yw", authDomain:"ucpairing.firebaseapp.com", projectId:"ucpairing" });
const db  = initializeFirestore(app,{experimentalAutoDetectLongPolling:true});
log('Firebase ready. projectId=', app.options.projectId);
const toJSONDesc = d=>d?{type:d.type,sdp:d.sdp}:null;

async function startCloudWith(code){
  if(!role){alert('Pick role');return;}
  const id=sixDigits(code);$('#code').value=id;
  const roomRef=doc(db,'rooms',id);const exp=Timestamp.fromMillis(Date.now()+7*24*60*60*1000);
  pc=newPCCloud();attachPCHandlers();
  if(role==='host'){
    dc=pc.createDataChannel('x');attachDC();
    const offer=await pc.createOffer();await pc.setLocalDescription(offer);
    await setDoc(roomRef,{offer:toJSONDesc(pc.localDescription),exp},{merge:true});
    await waitIceComplete(pc);
    await updateDoc(roomRef,{offer:toJSONDesc(pc.localDescription)});
    onSnapshot(roomRef,async s=>{const d=s.data()||{};if(d.answer&&!pc.currentRemoteDescription){await pc.setRemoteDescription(d.answer);log('Cloud: got answer');}});
  }else{
    onSnapshot(roomRef,async s=>{
      const d=s.data()||{};
      if(d.offer&&!pc.currentRemoteDescription){
        await pc.setRemoteDescription(d.offer);
        const ans=await pc.createAnswer();await pc.setLocalDescription(ans);
        await setDoc(roomRef,{answer:toJSONDesc(pc.localDescription),exp},{merge:true});
        await waitIceComplete(pc);
        await updateDoc(roomRef,{answer:toJSONDesc(pc.localDescription)});
      }
    });
  }
}
$('#startCloud').onclick=()=>startCloudWith($('#code').value||Math.floor(Math.random()*1e6));
$('#resetRoom').onclick=async()=>{const id=sixDigits($('#code').value||'');if(!id)return;await updateDoc(doc(db,'rooms',id),{offer:deleteField(),answer:deleteField()}).catch(()=>{});};

/* Random code */
$('#randCode').onclick=()=>{if(role!=='host')return;const code=String(Math.floor(Math.random()*1e6)).padStart(6,'0');$('#code').value=code;log('Random code:',code);};

/* QR logic */
const QR_PREFIX='UCP1|', MAX_CHUNK=350;
function splitChunks(s){let a=[];for(let i=0;i<s.length;i+=MAX_CHUNK)a.push(s.slice(i,i+MAX_CHUNK));return a;}
function renderQR(t){const q=qrcode(0,'L');q.addData(t);q.make();return q.createSvgTag(2);}
let qrPacked='',qrChunks=[],qrMode='single',qrIdx=0;
function showQR(){if(qrMode==='single'){$('#qrWrap').innerHTML=renderQR(qrPacked);$('#qrNav').style.display='none';}else{$('#qrWrap').innerHTML=renderQR(`${QR_PREFIX}${qrChunks.length}|${qrIdx+1}|${qrChunks[qrIdx]}`);$('#qrIndex').textContent=`${qrIdx+1}/${qrChunks.length}`;$('#qrNav').style.display='flex';}}
$('#qrPrev').onclick=()=>{qrIdx=(qrIdx-1+qrChunks.length)%qrChunks.length;showQR();};
$('#qrNext').onclick=()=>{qrIdx=(qrIdx+1)%qrChunks.length;showQR();};

$('#qrMake').onclick=async()=>{
  if(!role){alert('Pick role');return;}
  pc=newPCLocal();attachPCHandlers();
  if(role==='host'){dc=pc.createDataChannel('x');attachDC();}
  const desc=role==='host'?await pc.createOffer():await pc.createAnswer();
  await pc.setLocalDescription(desc);await waitIceComplete(pc);
  qrPacked=pack({role,sdp:{type:pc.localDescription.type,sdp:pc.localDescription.sdp}});
  qrMode='single';$('#qrToggle').style.display='inline';showQR();
};
$('#qrToggle').onclick=()=>{qrChunks=splitChunks(qrPacked);qrIdx=0;qrMode=(qrMode==='single'?'multi':'single');showQR();};

/* Scanner */
let asm={total:0,got:new Set(),parts:[]};
function resetAsm(){asm={total:0,got:new Set(),parts:[]};$('#qrProgress').textContent='';}
function absorb(text){
  if(text.startsWith(QR_PREFIX)){
    const rest=text.slice(QR_PREFIX.length);
    const p1=rest.indexOf('|'),p2=rest.indexOf('|',p1+1);if(p1<0||p2<0)return;
    const total=+rest.slice(0,p1),index=+rest.slice(p1+1,p2),data=rest.slice(p2+1);
    if(!asm.total){asm.total=total;asm.parts=Array(total).fill('');}
    if(!asm.got.has(index)){asm.got.add(index);asm.parts[index-1]=data;$('#qrProgress').textContent=`Got ${asm.got.size}/${asm.total}`;}
    if(asm.got.size===asm.total){const packed=asm.parts.join('');resetAsm();applyPacked(packed);}
  }else{applyPacked(text);}
}
async function applyPacked(packed){
  try{
    const obj=unpack(packed);
    if(!pc)pc=newPCLocal(),attachPCHandlers();
    if(role==='host'&&obj.role==='join'){
      await pc.setRemoteDescription(obj.sdp);
      log('QR: answer applied â€” connected soon');
    }else if(role==='join'&&obj.role==='host'){
      await pc.setRemoteDescription(obj.sdp);
      const ans=await pc.createAnswer();await pc.setLocalDescription(ans);await waitIceComplete(pc);
      qrPacked=pack({role,sdp:{type:pc.localDescription.type,sdp:pc.localDescription.sdp}});
      qrMode='single';$('#qrToggle').style.display='inline';showQR();
      log('QR: reply ready');
    }
  }catch(e){console.error(e);log('ERR applyPacked',e.message||e);}
}
$('#qrApply').onclick=()=>{const t=$('#qrPaste').value.trim();if(t){absorb(t);$('#qrPaste').value='';}};
let scanner=null;
$('#scanStart').onclick=()=>{scanner=new Html5Qrcode("reader");scanner.start({facingMode:"environment"},{fps:10,qrbox:220},txt=>absorb(txt)).catch(err=>log('scan ERR',err));};
$('#scanStop').onclick=()=>{scanner?.stop().then(()=>scanner.clear()).catch(()=>{});scanner=null;};
</script>
</body>
</html>
