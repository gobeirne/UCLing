<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pairing Demo â€” Cloud (STUN) + QR (Offline LAN)</title>
<style>
  :root{--bg:#f7f7f8;--fg:#222;--muted:#666;--ok:#1b5e20;--okbg:#e8f5e9;--warn:#795548;--warnbg:#fff8e1;--bad:#b71c1c;--badbg:#ffebee}
  body{margin:0;padding:16px;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  h1{margin:0 0 12px;font-size:18px}
  .row{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
  .muted{color:var(--muted);font-size:.9rem}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  input,textarea{padding:6px;border:1px solid #ccc;border-radius:8px}
  textarea{width:100%;height:110px;font:12px ui-monospace,monospace}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9rem}
  .ok{background:var(--okbg);color:var(--ok)} .warn{background:var(--warnbg);color:var(--warn)} .bad{background:var(--badbg);color:var(--bad)}
  #log{font-size:.86rem;max-height:190px;overflow:auto;white-space:pre-wrap}
  #qrWrap svg{width:280px;height:280px}
  .qr-nav{display:flex;gap:8px;align-items:center}
</style>

<!-- Offline libs (put these next to this HTML) -->
<script src="qrcode.js"></script>              <!-- QR encoder -->
<script src="pako.min.js"></script>            <!-- Deflate -->
<script src="html5-qrcode.min.js"></script>    <!-- Camera scanner -->
</head>
<body>
<h1>Pairing Demo â€” Cloud (STUN) + QR (Offline LAN)</h1>

<div class="row">
  <div class="card">
    <h2>Role</h2>
    <button id="roleHost">Host</button>
    <button id="roleJoin">Joiner</button>
    <span id="roleBadge" class="status warn">no role</span>
  </div>
  <div class="card">
    <h2>Status</h2>
    <div>Peer: <span id="conn" class="status warn">idle</span> &nbsp; DataChannel: <span id="dc" class="status warn">-</span></div>
    <div id="log" class="muted"></div>
  </div>
</div>

<div class="card">
  <h2>Cloud (6-digit, STUN, single SDP)</h2>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
<label>Code: <input id="code" inputmode="numeric" maxlength="6" style="width:9ch"/></label>
<button id="randCode">ðŸŽ² Random</button>
<button id="startCloud">Start</button>
<button id="resetRoom">Reset</button>
    <span class="muted">Room doc appears immediately; SDP updates after ICE completes.</span>
  </div>
</div>

<div class="card">
  <h2>QR (offline LAN)</h2>
  <div class="row">
    <div class="card">
      <h3>Make & show my QR</h3>
      <button id="qrMake">Create my QR</button>
      <button id="qrToggle" style="display:none;">âš  Trouble scanning?</button>
      <div id="qrWrap"></div>
      <div id="qrNav" class="qr-nav" style="display:none;">
        <button id="qrPrev">â—€ Prev</button>
        <span id="qrIndex" class="muted">0/0</span>
        <button id="qrNext">Next â–¶</button>
      </div>
    </div>
    <div class="card">
      <h3>Scan partner QR</h3>
      <button id="scanStart">Start Camera Scan</button>
      <button id="scanStop">Stop</button>
      <div id="reader" style="width:320px;max-width:100%;"></div>
      <textarea id="qrPaste" placeholder="Paste scanned textâ€¦"></textarea>
      <button id="qrApply">Apply</button>
      <div id="qrProgress" class="muted"></div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Actions</h2>
  <button id="btnBeep" disabled>Beep</button>
  <button id="btnChirp" disabled>Chirp</button>
  <button id="btnPing" disabled>Ping</button>
</div>

<script type="module">
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), logEl=$('#log');
function log(...a){const line=a.join(' ');console.log(line);logEl.textContent+=line+"\\n";logEl.scrollTop=logEl.scrollHeight;}
function badge(el,t,c){el.textContent=t;el.className='status '+c;}
function sixDigits(x){return(''+x).replace(/\\D/g,'').slice(0,6).padStart(6,'0');}
function b64urlFromBytes(u8){return btoa(String.fromCharCode(...u8)).replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=+$/,'');}
function bytesFromB64url(s){s=s.replace(/-/g,'+').replace(/_/g,'/');while(s.length%4)s+='=';const bin=atob(s);const u8=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)u8[i]=bin.charCodeAt(i);return u8;}
function pack(obj){const json=JSON.stringify(obj).replace(/\\r?\\n/g,'\\\\n');const def=pako.deflate(json);return b64urlFromBytes(def);}
function unpack(s){const bytes=bytesFromB64url(s);const str=pako.inflate(bytes,{to:'string'});return JSON.parse(str);}

/* ===== Role ===== */
let role=null;
$('#roleHost').onclick=()=>{role='host';badge($('#roleBadge'),'Host','ok');};
$('#roleJoin').onclick=()=>{role='join';badge($('#roleBadge'),'Joiner','ok');};

/* ===== WebRTC core ===== */
let pc,dc;
function newPCCloud(){return new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});}
function newPCLocal(){return new RTCPeerConnection({iceServers:[]});}
async function waitIceComplete(pcx){if(pcx.iceGatheringState==='complete')return;await new Promise(res=>pcx.addEventListener('icegatheringstatechange',()=>pcx.iceGatheringState==='complete'&&res()));}
function attachPCHandlers(){pc.onconnectionstatechange=()=>{const st=pc.connectionState;badge($('#conn'),st,st==='connected'?'ok':(st==='failed'||st==='disconnected'?'bad':'warn'));['#btnBeep','#btnChirp','#btnPing'].forEach(id=>$(id).disabled=st!=='connected');};pc.ondatachannel=e=>{dc=e.channel;attachDC();};}
function attachDC(){badge($('#dc'),dc.readyState,dc.readyState==='open'?'ok':'warn');dc.onopen=()=>badge($('#dc'),dc.readyState,'ok');dc.onclose=()=>badge($('#dc'),dc.readyState,'bad');dc.onmessage=e=>log('RX',e.data);}
function send(m){if(dc&&dc.readyState==='open')dc.send(m);}
$('#btnBeep').onclick=()=>send('BEEP');$('#btnChirp').onclick=()=>send('CHIRP');$('#btnPing').onclick=()=>send('PING');

/* ===== Firebase (signaling, with debug) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {
  initializeFirestore, doc, setDoc, onSnapshot, updateDoc, Timestamp, deleteField, setLogLevel
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyBZhqD0RE0miHDHhhlDZerGIsD0S5oy4Yw",
  authDomain:"ucpairing.firebaseapp.com",
  projectId:"ucpairing"
});
const db  = initializeFirestore(app,{experimentalAutoDetectLongPolling:true});
setLogLevel('debug'); // Firestore SDK debug in console
log('Firebase ready. projectId=', app.options.projectId);

/* Helper: write immediately, then update after ICE */
async function writeOrUpdate(roomRef, field, desc){
  try{
    await setDoc(roomRef, {[field]: desc}, {merge:true});
    log('Firestore setDoc:', field, 'written.');
  }catch(e){
    console.error(e); log('ERR setDoc', field, e.message||e);
  }
}
async function upgradeSDP(roomRef, field){
  try{
    await updateDoc(roomRef, {[field]: pc.localDescription});
    log('Firestore updateDoc:', field, 'updated after ICE.');
  }catch(e){
    console.error(e); log('ERR updateDoc', field, e.message||e);
  }
}

/* Cloud flow (no trickle; immediate write + post-ICE update) */
async function startCloudWith(code){
  if(!role){alert('Pick role');return;}
  const id = sixDigits(code);
  $('#code').value = id;
  const roomRef=doc(db,'rooms',id);
  const exp=Timestamp.fromMillis(Date.now()+7*24*60*60*1000);

  pc=newPCCloud();attachPCHandlers();

  if(role==='host'){
    dc=pc.createDataChannel('x');attachDC();
    const offer=await pc.createOffer();await pc.setLocalDescription(offer);
    await writeOrUpdate(roomRef,'offer', pc.localDescription);
    await updateDoc(roomRef,{exp}).catch(()=>{});
    // complete ICE then upgrade offer SDP with candidates
    await waitIceComplete(pc);
    await upgradeSDP(roomRef,'offer');

    onSnapshot(roomRef, async s=>{
      try{
        const d=s.data()||{};
        if(d.answer && !pc.currentRemoteDescription){
          await pc.setRemoteDescription(d.answer);
          log('Cloud: got answer; connectingâ€¦');
        }
      }catch(e){console.error(e);log('ERR onSnapshot host', e.message||e);}
    }, err=>{console.error(err);log('onSnapshot error (host):', err.message||err);});

  } else { // joiner
    onSnapshot(roomRef, async s=>{
      try{
        const d=s.data()||{};
        if(d.offer && !pc.currentRemoteDescription){
          await pc.setRemoteDescription(d.offer);
          const ans=await pc.createAnswer();await pc.setLocalDescription(ans);
          await writeOrUpdate(roomRef,'answer', pc.localDescription);
          await updateDoc(roomRef,{exp}).catch(()=>{});
          await waitIceComplete(pc);
          await upgradeSDP(roomRef,'answer');
          log('Cloud: answer posted & upgraded.');
        }
      }catch(e){console.error(e);log('ERR onSnapshot joiner', e.message||e);}
    }, err=>{console.error(err);log('onSnapshot error (joiner):', err.message||err);});
  }
}

$('#startCloud').onclick=()=>startCloudWith($('#code').value||Math.floor(Math.random()*1e6));
$('#randCode').onclick = ()=>{
  if(role!=='host'){ alert('Only Host can pick random code'); return; }
  const code = String(Math.floor(Math.random()*1e6)).padStart(6,'0');
  $('#code').value = code;
  log('Random code generated:', code);
};

$('#resetRoom').onclick=async()=>{
  const id=sixDigits($('#code').value||'');
  if(!id) return;
  try{
    await updateDoc(doc(db,'rooms',id), {offer: deleteField(), answer: deleteField()});
    log('Room fields cleared:', id);
  }catch(e){console.error(e);log('ERR resetRoom', e.message||e);}
};

/* ===== QR: single by default, chunked fallback ===== */
const QR_PREFIX='UCP1|', MAX_CHUNK=350;
function splitChunks(s){let a=[];for(let i=0;i<s.length;i+=MAX_CHUNK)a.push(s.slice(i,i+MAX_CHUNK));return a;}
function renderQR(t){const q=qrcode(0,'L');q.addData(t);q.make();return q.createSvgTag(2);}

let qrPacked='', qrChunks=[], qrMode='single', qrIdx=0;
function showQR(){
  if(qrMode==='single'){
    $('#qrWrap').innerHTML=renderQR(qrPacked);
    $('#qrNav').style.display='none';
  }else{
    $('#qrWrap').innerHTML=renderQR(`${QR_PREFIX}${qrChunks.length}|${qrIdx+1}|${qrChunks[qrIdx]}`);
    $('#qrIndex').textContent=`${qrIdx+1}/${qrChunks.length}`;
    $('#qrNav').style.display='flex';
  }
}
$('#qrPrev').onclick=()=>{qrIdx=(qrIdx-1+qrChunks.length)%qrChunks.length;showQR();};
$('#qrNext').onclick=()=>{qrIdx=(qrIdx+1)%qrChunks.length;showQR();};

$('#qrMake').onclick=async()=>{
  if(!role){alert('Pick role');return;}
  pc=newPCLocal();attachPCHandlers();
  if(role==='host'){dc=pc.createDataChannel('x');attachDC();}
  const desc=role==='host'?await pc.createOffer():await pc.createAnswer();
  await pc.setLocalDescription(desc);
  await waitIceComplete(pc);
  qrPacked=pack({role,sdp:pc.localDescription});
  qrMode='single'; $('#qrToggle').style.display='inline'; showQR();
};
$('#qrToggle').onclick=()=>{qrChunks=splitChunks(qrPacked);qrIdx=0;qrMode=(qrMode==='single'?'multi':'single');showQR();};

/* ===== Scanner (handles single OR chunked) ===== */
let asm={total:0,got:new Set(),parts:[]};
function resetAsm(){asm={total:0,got:new Set(),parts:[]};$('#qrProgress').textContent='';}
function absorb(text){
  if(text.startsWith(QR_PREFIX)){
    const rest=text.slice(QR_PREFIX.length);
    const p1=rest.indexOf('|'), p2=rest.indexOf('|',p1+1);
    if(p1<0||p2<0) return;
    const total=+rest.slice(0,p1), index=+rest.slice(p1+1,p2), data=rest.slice(p2+1);
    if(!asm.total){asm.total=total;asm.parts=Array(total).fill('');}
    if(!asm.got.has(index)){asm.got.add(index);asm.parts[index-1]=data;$('#qrProgress').textContent=`Got ${asm.got.size}/${asm.total}`;}
    if(asm.got.size===asm.total){const packed=asm.parts.join('');resetAsm();applyPacked(packed);}
  }else{
    // single QR packed payload
    applyPacked(text);
  }
}
async function applyPacked(packed){
  try{
    const obj=unpack(packed);
    if(!pc) pc=newPCLocal(), attachPCHandlers();
    if(role==='host' && obj.role==='join'){
      await pc.setRemoteDescription(obj.sdp);
      log('QR: answer applied â€” connectingâ€¦');
    }else if(role==='join' && obj.role==='host'){
      await pc.setRemoteDescription(obj.sdp);
      const ans=await pc.createAnswer(); await pc.setLocalDescription(ans);
      await waitIceComplete(pc);
      // show reply back to host (single by default)
      qrPacked=pack({role,sdp:pc.localDescription});
      qrMode='single'; $('#qrToggle').style.display='inline'; showQR();
      log('QR: reply ready.');
    }else{
      alert('Role mismatch. One must be Host, the other Joiner.');
    }
  }catch(e){console.error(e);log('ERR applyPacked', e.message||e);}
}
$('#qrApply').onclick=()=>{const t=$('#qrPaste').value.trim(); if(t){absorb(t); $('#qrPaste').value='';}};

let scanner=null;
$('#scanStart').onclick=()=>{
  try{
    scanner=new Html5Qrcode("reader");
    scanner.start({facingMode:"environment"},{fps:10,qrbox:220},txt=>absorb(txt),_=>{}).catch(err=>{console.error(err);log('scanner.start ERR',err.message||err);});
  }catch(e){console.error(e);log('scanner init ERR',e.message||e);}
};
$('#scanStop').onclick=()=>{scanner?.stop().then(()=>scanner.clear()).catch(()=>{});scanner=null;};
</script>
</body>
</html>
