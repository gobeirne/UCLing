<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pairing Demo â€” Cloud + QR</title>
<style>
  body{margin:0;padding:16px;font:15px/1.4 system-ui;background:#f7f7f8;color:#222}
  h1{margin:0 0 12px;font-size:18px}
  .row{display:grid;gap:12px;grid-template-columns:1fr} 
  @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  input,textarea{padding:6px;border:1px solid #ccc;border-radius:8px}
  textarea{width:100%;height:110px;font:12px monospace}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9rem}
  .ok{background:#e8f5e9;color:#1b5e20} .warn{background:#fff8e1;color:#795548} .bad{background:#ffebee;color:#b71c1c}
  #log{font-size:.85rem;max-height:180px;overflow:auto;white-space:pre-wrap}
  #qrWrap{max-width:420px}
  .qr-nav{display:flex;gap:8px;align-items:center}
  #ver{color:#666;font-size:.8rem}
</style>
<script src="qrcode.js"></script>
<script src="pako.min.js"></script>
<script src="html5-qrcode.min.js"></script>
</head>
<body>
<h1>Pairing Demo â€” Cloud (STUN) + QR (Offline LAN) <span id="ver">v1.4</span></h1>

<div class="row">
  <div class="card">
    <h2>Role</h2>
    <button id="roleHost">Host</button>
    <button id="roleJoin">Joiner</button>
    <span id="roleBadge" class="status warn">no role</span>
  </div>
  <div class="card">
    <h2>Status</h2>
    <div>Peer: <span id="conn" class="status warn">idle</span> &nbsp; DataChannel: <span id="dc" class="status warn">-</span></div>
    <div id="log"></div>
  </div>
</div>

<div class="card">
  <h2>Cloud (6-digit)</h2>
  <label>Code: <input id="code" inputmode="numeric" maxlength="6" style="width:9ch"/></label>
  <button id="randStart" style="display:none;">ðŸŽ² Random Code & Start</button>
  <button id="startCloud" style="display:none;">Start</button>
  <button id="resetRoom" style="display:none;">Reset</button>
</div>

<div class="card">
  <h2>QR (offline LAN)</h2>
  <div class="row">
    <div class="card">
      <h3>Make & show my QR (Host)</h3>
      <button id="qrMake" disabled>Create my QR</button>
      <button id="qrTrouble" style="display:none;">âš  Trouble scanning? (4 fat codes)</button>
      <label><input type="checkbox" id="robustECC"> Robust (ECC=M)</label>
      <div id="qrWrap"></div>
      <div id="qrNav" class="qr-nav" style="display:none;">
        <button id="qrPrev">â—€ Prev</button>
        <span id="qrIndex"></span>
        <button id="qrNext">Next â–¶</button>
      </div>
    </div>
    <div class="card">
      <h3>Scan partner QR (Joiner)</h3>
      <button id="scanStart" disabled>Start Camera Scan</button>
      <button id="scanStop" disabled>Stop</button>
      <div id="reader" style="width:320px;max-width:100%;"></div>
      <textarea id="qrPaste" placeholder="Paste scanned textâ€¦"></textarea>
      <button id="qrApply" disabled>Apply</button>
      <div id="qrProgress"></div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Actions</h2>
  <button id="btnBeep" disabled>Beep</button>
  <button id="btnChirp" disabled>Chirp</button>
  <button id="btnPing" disabled>Ping</button>
</div>

<script type="module">
const $=s=>document.querySelector(s),logEl=$('#log');
function log(...a){logEl.textContent+=a.join(' ')+"\\n";logEl.scrollTop=logEl.scrollHeight;}
function badge(el,t,c){el.textContent=t;el.className='status '+c;}
function sixDigits(x){return(''+x).replace(/\\D/g,'').slice(0,6).padStart(6,'0');}
function b64url(u8){return btoa(String.fromCharCode(...u8)).replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=+$/,'');}
function unb64url(s){s=s.replace(/-/g,'+').replace(/_/g,'/');while(s.length%4)s+='=';const bin=atob(s);return Uint8Array.from(bin,c=>c.charCodeAt(0));}
function pack(o){return b64url(pako.deflate(JSON.stringify(o)));}
function unpack(s){return JSON.parse(pako.inflate(unb64url(s),{to:'string'}));}

/* Role handling */
let role=null;
function setRole(r){
  role=r; badge($('#roleBadge'),r,'ok');
  if(r==='host'){
    $('#randStart').style.display='inline';
    $('#startCloud').style.display='none';
    $('#resetRoom').style.display='none';
    $('#qrMake').disabled=false;
    $('#scanStart').disabled=true;$('#scanStop').disabled=true;$('#qrApply').disabled=true;
  }else{
    $('#randStart').style.display='none';
    $('#startCloud').style.display='inline';
    $('#resetRoom').style.display='inline';
    $('#qrMake').disabled=true;
    $('#scanStart').disabled=false;$('#scanStop').disabled=false;$('#qrApply').disabled=false;
  }
}
$('#roleHost').onclick=()=>setRole('host');
$('#roleJoin').onclick=()=>setRole('join');
$('#code').onfocus=()=>{if(role==='host'){ $('#randStart').style.display='none'; $('#startCloud').style.display='inline'; $('#resetRoom').style.display='inline'; }};

/* WebRTC skeleton */
let pc,dc;
function newPC(stun=true){return new RTCPeerConnection(stun?{iceServers:[{urls:'stun:stun.l.google.com:19302'}]}:{iceServers:[]});}
async function waitIce(p){if(p.iceGatheringState==='complete')return;await new Promise(r=>p.addEventListener('icegatheringstatechange',()=>p.iceGatheringState==='complete'&&r()));}
function attachPC(){pc.onconnectionstatechange=()=>{const s=pc.connectionState;badge($('#conn'),s,s==='connected'?'ok':s==='failed'?'bad':'warn');['#btnBeep','#btnChirp','#btnPing'].forEach(id=>$(id).disabled=s!=='connected');};pc.ondatachannel=e=>{dc=e.channel;attachDC();};}
function attachDC(){badge($('#dc'),dc.readyState,dc.readyState==='open'?'ok':'warn');dc.onopen=()=>badge($('#dc'),'open','ok');dc.onclose=()=>badge($('#dc'),'closed','bad');dc.onmessage=e=>log('RX',e.data);}
function send(m){if(dc&&dc.readyState==='open')dc.send(m);}
$('#btnBeep').onclick=()=>send('BEEP');$('#btnChirp').onclick=()=>send('CHIRP');$('#btnPing').onclick=()=>send('PING');

/* Firebase init */
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {initializeFirestore,doc,setDoc,onSnapshot,updateDoc,Timestamp,deleteField} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyBZhqD0RE0miHDHhhlDZerGIsD0S5oy4Yw",authDomain:"ucpairing.firebaseapp.com",projectId:"ucpairing"});
const db=initializeFirestore(app,{experimentalAutoDetectLongPolling:true});
const toJSON=d=>d?{type:d.type,sdp:d.sdp}:null;
async function startCloud(code){
  const id=sixDigits(code);$('#code').value=id;const ref=doc(db,'rooms',id);
  const expiresAt=Timestamp.fromMillis(Date.now()+7*24*60*60*1000);
  pc=newPC(true);attachPC();
  if(role==='host'){
    dc=pc.createDataChannel('x');attachDC();
    await pc.setLocalDescription(await pc.createOffer());
    await setDoc(ref,{offer:toJSON(pc.localDescription),expiresAt},{merge:true});
    await waitIce(pc);await updateDoc(ref,{offer:toJSON(pc.localDescription)});
    onSnapshot(ref,async s=>{const d=s.data()||{};if(d.answer&&!pc.currentRemoteDescription){await pc.setRemoteDescription(d.answer);log('Cloud: got answer');}});
  }else{
    onSnapshot(ref,async s=>{const d=s.data()||{};if(d.offer&&!pc.currentRemoteDescription){await pc.setRemoteDescription(d.offer);await pc.setLocalDescription(await pc.createAnswer());await setDoc(ref,{answer:toJSON(pc.localDescription),expiresAt},{merge:true});await waitIce(pc);await updateDoc(ref,{answer:toJSON(pc.localDescription)});}});
  }
}
$('#randStart').onclick=()=>{const c=String(Math.floor(Math.random()*1e6)).padStart(6,'0');$('#code').value=c;startCloud(c);};
$('#startCloud').onclick=()=>startCloud($('#code').value||Math.floor(Math.random()*1e6));
$('#resetRoom').onclick=()=>updateDoc(doc(db,'rooms',sixDigits($('#code').value||'')),{offer:deleteField(),answer:deleteField()}).catch(()=>{});

/* QR logic */
const QR_PREFIX='UCP1|';const CHUNK_COUNT=4,SCALE_SINGLE=3,SCALE_CHUNK=6;
function split4(s){const sz=Math.ceil(s.length/CHUNK_COUNT);return Array.from({length:CHUNK_COUNT},(_,i)=>s.slice(i*sz,(i+1)*sz));}
function renderQR(txt,scale,ecc){const q=qrcode(0,ecc);q.addData(txt);q.make();return q.createSvgTag(scale);}
let qrPacked='',qrChunks=[],qrMode='single',qrIdx=0;
function showQR(){const ecc=$('#robustECC').checked?'M':'L';if(qrMode==='single'){$('#qrWrap').innerHTML=renderQR(qrPacked,SCALE_SINGLE,ecc);$('#qrNav').style.display='none';}else{const pay=`${QR_PREFIX}${qrChunks.length}|${qrIdx+1}|${qrChunks[qrIdx]}`;$('#qrWrap').innerHTML=renderQR(pay,SCALE_CHUNK,ecc);$('#qrIndex').textContent=`${qrIdx+1}/${qrChunks.length}`;$('#qrNav').style.display='flex';}}
$('#qrPrev').onclick=()=>{qrIdx=(qrIdx-1+qrChunks.length)%qrChunks.length;showQR();};
$('#qrNext').onclick=()=>{qrIdx=(qrIdx+1)%qrChunks.length;showQR();};
$('#qrMake').onclick=async()=>{pc=newPC(false);attachPC();if(role==='host'){dc=pc.createDataChannel('x');attachDC();}await pc.setLocalDescription(role==='host'?await pc.createOffer():await pc.createAnswer());await waitIce(pc);qrPacked=pack({role,sdp:{type:pc.localDescription.type,sdp:pc.localDescription.sdp}});qrMode='single';$('#qrTrouble').style.display='inline';showQR();if(role==='host'){$('#scanStart').disabled=false;$('#scanStop').disabled=false;$('#qrApply').disabled=false;}};
$('#qrTrouble').onclick=()=>{qrChunks=split4(qrPacked);qrIdx=0;qrMode='multi';showQR();};

/* QR scan + assembly */
let asm={total:0,got:new Set(),parts:[]};
function resetAsm(){asm={total:0,got:new Set(),parts:[]};$('#qrProgress').textContent='';}
function absorb(t){if(t.startsWith(QR_PREFIX)){const r=t.slice(QR_PREFIX.length),p1=r.indexOf('|'),p2=r.indexOf('|',p1+1);if(p1<0||p2<0)return;const total=+r.slice(0,p1),idx=+r.slice(p1+1,p2),dat=r.slice(p2+1);if(!asm.total){asm.total=total;asm.parts=Array(total).fill('');}asm.got.add(idx);asm.parts[idx-1]=dat;$('#qrProgress').textContent=`Got parts: ${[...asm.got].sort().join(', ')} / ${asm.total}`;if(asm.got.size===asm.total){const pk=asm.parts.join('');resetAsm();applyPacked(pk);}}else applyPacked(t);}
async function applyPacked(p){try{const o=unpack(p);if(!pc)pc=newPC(false),attachPC();if(role==='host'&&o.role==='join'){if(!pc.currentRemoteDescription){await pc.setRemoteDescription(o.sdp);log('QR: answer applied');}else log('QR: duplicate answer ignored');}else if(role==='join'&&o.role==='host'){if(!pc.currentRemoteDescription){await pc.setRemoteDescription(o.sdp);await pc.setLocalDescription(await pc.createAnswer());await waitIce(pc);qrPacked=pack({role,sdp:{type:pc.localDescription.type,sdp:pc.localDescription.sdp}});qrMode='single';$('#qrTrouble').style.display='inline';showQR();log('QR: reply ready');}else log('QR: duplicate offer ignored');}else alert('Role mismatch');}catch(e){log('ERR applyPacked',e.message);}}
$('#qrApply').onclick=()=>{const t=$('#qrPaste').value.trim();if(t){absorb(t);$('#qrPaste').value='';}};
let scanner=null;$('#scanStart').onclick=()=>{scanner=new Html5Qrcode("reader");scanner.start({facingMode:"environment"},{fps:10,qrbox:240},txt=>absorb(txt)).catch(e=>log('scan ERR',e));};$('#scanStop').onclick=()=>{scanner?.stop().then(()=>scanner.clear());scanner=null;};
</script>
</body>
</html>
