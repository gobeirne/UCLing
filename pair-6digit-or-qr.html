<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pairing Demo — Cloud (STUN) + QR (Offline LAN)</title>
<style>
  :root{--bg:#f7f7f8;--fg:#222;--muted:#666;--ok:#1b5e20;--okbg:#e8f5e9;--warn:#795548;--warnbg:#fff8e1;--bad:#b71c1c;--badbg:#ffebee}
  body{margin:0;padding:16px;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  h1{margin:0 0 12px;font-size:18px}
  .row{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
  .muted{color:var(--muted);font-size:.9rem}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  input,textarea{padding:6px;border:1px solid #ccc;border-radius:8px}
  textarea{width:100%;height:110px;font:12px ui-monospace,monospace}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9rem}
  .ok{background:var(--okbg);color:var(--ok)} .warn{background:var(--warnbg);color:var(--warn)} .bad{background:var(--badbg);color:var(--bad)}
  #log{font-size:.86rem;max-height:180px;overflow:auto;white-space:pre-wrap}
  #qrWrap svg{width:220px;height:220px} /* crisp, small QR */
</style>

<!-- Offline-capable libs (place local copies in the same folder) -->
<script src="qrcode.js"></script>              <!-- QR encoder (generator) -->
<script src="pako.min.js"></script>            <!-- Deflate compression -->
<script src="html5-qrcode.min.js"></script>    <!-- Camera QR scanner -->
</head>
<body>
<h1>Pairing Demo — Cloud (STUN) + QR (Offline LAN)</h1>

<div class="row">
  <div class="card">
    <h2>Role</h2>
    <button id="roleHost">Host</button>
    <button id="roleJoin">Joiner</button>
    <span id="roleBadge" class="status warn">no role</span>
    <div class="muted" style="margin-top:6px">Cloud = works across networks. QR = offline same-LAN fallback.</div>
  </div>
  <div class="card">
    <h2>Status</h2>
    <div>Peer: <span id="conn" class="status warn">idle</span> &nbsp; DataChannel: <span id="dc" class="status warn">-</span></div>
    <div id="log" class="muted"></div>
  </div>
</div>

<div class="card">
  <h2>Cloud (6-digit, STUN, no trickle)</h2>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <label>Code: <input id="code" inputmode="numeric" pattern="[0-9]*" maxlength="6" style="width:9ch"/></label>
    <button id="startCloud">Start</button>
    <button id="btnReset">Reset Room</button>
    <span class="muted">Rooms auto-expire in 7 days. No TURN—cross-network works when NATs behave.</span>
  </div>
</div>

<div class="card">
  <h2>QR (offline LAN, compressed single-SDP)</h2>
  <div class="row">
    <div class="card">
      <h3>Make & show my QR</h3>
      <button id="qrMake">Create my QR</button>
      <div id="qrWrap" style="margin-top:8px"></div>
      <div class="muted">Smaller, crisper QR via compression + SVG.</div>
    </div>
    <div class="card">
      <h3>Scan partner QR</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:6px">
        <button id="scanStart">Start Camera Scan</button>
        <button id="scanStop">Stop</button>
      </div>
      <div id="reader" style="width:320px;max-width:100%;"></div>
      <div class="muted" style="margin:8px 0">…or paste the QR text:</div>
      <textarea id="qrPaste" placeholder="Paste partner QR text (compressed base64url)…"></textarea>
      <button id="qrScan">Apply</button>
    </div>
  </div>
</div>

<div class="card">
  <h2>Actions</h2>
  <button id="btnBeep" disabled>Beep (440 Hz)</button>
  <button id="btnChirp" disabled>Chirp</button>
  <button id="btnPing" disabled>Ping</button>
</div>

<script type="module">
/* ================= Helpers ================= */
const $=s=>document.querySelector(s), logEl=$('#log');
function log(...a){logEl.textContent+=a.join(' ')+"\\n";logEl.scrollTop=logEl.scrollHeight;}
function badge(el,t,c){el.textContent=t;el.className='status '+c;}
function sixDigits(x){return(''+x).replace(/\D/g,'').slice(0,6).padStart(6,'0');}
function delay(ms){return new Promise(r=>setTimeout(r,ms));}

/* Compression helpers (pako + base64url) */
function b64urlFromBytes(u8){return btoa(String.fromCharCode(...u8)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
function bytesFromB64url(s){s=s.replace(/-/g,'+').replace(/_/g,'/');while(s.length%4)s+='=';const bin=atob(s);const u8=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)u8[i]=bin.charCodeAt(i);return u8;}
function pack(obj){const json=JSON.stringify(obj).replace(/\r?\n/g,'\\n');const def=pako.deflate(json);return b64urlFromBytes(def);}
function unpack(s){const bytes=bytesFromB64url(s);const str=pako.inflate(bytes,{to:'string'});return JSON.parse(str);}

/* ================= Role ================= */
let role=null;
$('#roleHost').onclick=()=>{role='host';badge($('#roleBadge'),'Host','ok');};
$('#roleJoin').onclick=()=>{role='join';badge($('#roleBadge'),'Joiner','ok');};

/* ================= Web Audio ================= */
let ctx;function audio(){if(!ctx)ctx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});}
function beep(){audio();const t=ctx.currentTime,o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=440;
g.gain.setValueAtTime(0.001,t);g.gain.exponentialRampToValueAtTime(0.2,t+0.02);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
o.connect(g).connect(ctx.destination);o.start(t);o.stop(t+0.35);}
function chirp(){audio();const t=ctx.currentTime,o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';
o.frequency.setValueAtTime(500,t);o.frequency.linearRampToValueAtTime(2000,t+0.6);
g.gain.setValueAtTime(0.001,t);g.gain.exponentialRampToValueAtTime(0.2,t+0.02);g.gain.exponentialRampToValueAtTime(0.001,t+0.6);
o.connect(g).connect(ctx.destination);o.start(t);o.stop(t+0.65);}
['touchstart','mousedown','keydown'].forEach(e=>window.addEventListener(e,audio,{once:true}));

/* ================= WebRTC core ================= */
let pc,dc,roomUnsub=null;
function newPCCloud(){ // STUN on, works across networks (no trickle)
  return new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
}
function newPCLocal(){ // offline LAN only
  return new RTCPeerConnection({iceServers:[]});
}
async function waitIceComplete(pcx){
  if(pcx.iceGatheringState==='complete') return;
  await new Promise(res=>{
    pcx.addEventListener('icegatheringstatechange',()=>pcx.iceGatheringState==='complete'&&res(),{once:false});
  });
  // tiny settle time
  await delay(20);
}
function attachPCHandlers(){
  pc.onconnectionstatechange=()=>{
    const st=pc.connectionState;
    badge($('#conn'),st,st==='connected'?'ok':(st==='failed'||st==='disconnected'?'bad':'warn'));
    const up=st==='connected';['#btnBeep','#btnChirp','#btnPing'].forEach(id=>$(id).disabled=!up);
  };
  pc.ondatachannel = e => { dc=e.channel; attachDC(); };
}
function attachDC(){
  if(!dc)return;
  badge($('#dc'),dc.readyState,dc.readyState==='open'?'ok':'warn');
  dc.onopen = ()=>badge($('#dc'),dc.readyState,'ok');
  dc.onclose=()=>badge($('#dc'),dc.readyState,'bad');
  dc.onmessage = e=>{
    const m=JSON.parse(e.data);
    if(m.type==='BEEP')  beep();
    if(m.type==='CHIRP') chirp();
    log('RX',m.type);
  };
}
function send(m){ if(dc&&dc.readyState==='open') dc.send(JSON.stringify(m)); }
$('#btnBeep').onclick=()=>send({type:'BEEP'});
$('#btnChirp').onclick=()=>send({type:'CHIRP'});
$('#btnPing').onclick =()=>send({type:'PING'});

/* ================= Firebase (auto-init) ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { initializeFirestore, doc, setDoc, onSnapshot, updateDoc, Timestamp, deleteField } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBZhqD0RE0miHDHhhlDZerGIsD0S5oy4Yw",
  authDomain: "ucpairing.firebaseapp.com",
  projectId: "ucpairing",
  storageBucket: "ucpairing.firebasestorage.app",
  messagingSenderId: "663962026087",
  appId: "1:663962026087:web:a13ac7cca6fe8c1b6014c2"
};
const app = initializeApp(firebaseConfig);
const db  = initializeFirestore(app,{experimentalAutoDetectLongPolling:true,useFetchStreams:false});
log('Firebase ready');

/* ================= Cloud (no trickle, single SDP each) ================= */
async function startCloudWith(code){
  if(!role){alert('Pick role first');return;}
  code=sixDigits(code); $('#code').value=code;
  localStorage.setItem('pair.role',role); localStorage.setItem('pair.code',code);

  const roomRef=doc(db,'rooms',code);
  const expiresAt=Timestamp.fromMillis(Date.now()+7*24*60*60*1000);

  roomUnsub && roomUnsub();
  pc = newPCCloud(); attachPCHandlers();

  if(role==='host'){
    dc = pc.createDataChannel('ucktt'); attachDC();
    const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
    await waitIceComplete(pc); // gather STUN/host candidates into the SDP
    await setDoc(roomRef,{offer:pc.localDescription,expiresAt},{merge:true});

    roomUnsub = onSnapshot(roomRef, async snap=>{
      const d=snap.data()||{};
      if(d.answer && !pc.currentRemoteDescription){
        await pc.setRemoteDescription(d.answer);
        log('Cloud: got answer; connecting…');
      }
    });

  } else { // joiner
    roomUnsub = onSnapshot(roomRef, async snap=>{
      const d=snap.data()||{};
      if(d.offer && !pc.currentRemoteDescription){
        await pc.setRemoteDescription(d.offer);
        const ans=await pc.createAnswer(); await pc.setLocalDescription(ans);
        await waitIceComplete(pc);
        await updateDoc(roomRef,{answer:pc.localDescription,expiresAt});
        log('Cloud: posted answer.');
      }
    });
  }
}

$('#startCloud').onclick = ()=>startCloudWith($('#code').value || Math.floor(Math.random()*1e6));

$('#btnReset').onclick = async ()=>{
  const code=$('#code').value.trim(); if(!code) return;
  try{ pc?.close(); }catch{}
  const roomRef=doc(db,'rooms',code);
  await updateDoc(roomRef,{offer:deleteField(),answer:deleteField()}).catch(()=>{});
  log('Room cleared');
  await startCloudWith(code);
};

/* Auto-rejoin on load */
window.addEventListener('load',()=>{
  const r=localStorage.getItem('pair.role'), c=localStorage.getItem('pair.code');
  if(r&&c){ role=r; badge($('#roleBadge'), r==='host'?'Host':'Joiner','ok'); $('#code').value=c; startCloudWith(c); }
});

/* ================= QR (offline LAN, compressed) ================= */
function makeQR(text){
  const qr=qrcode(0,'L'); // lower EC => fewer modules
  qr.addData(text);
  qr.make();
  const wrap=$('#qrWrap');
  wrap.innerHTML = qr.createSvgTag(2); // module size 2; we scale via CSS
}

$('#qrMake').onclick = async ()=>{
  if(!role){alert('Pick role'); return;}
  pc = newPCLocal(); attachPCHandlers();
  if(role==='host'){ dc=pc.createDataChannel('ucktt'); attachDC(); }
  const desc = role==='host' ? await pc.createOffer() : await pc.createAnswer();
  await pc.setLocalDescription(desc);
  await waitIceComplete(pc); // host candidates only
  const payload = { role, sdp: pc.localDescription };
  const packed  = pack(payload); // deflate + base64url (compact)
  makeQR(packed);
  log('[QR] bytes:', packed.length);
};

$('#qrScan').onclick = async ()=>{
  const t=$('#qrPaste').value.trim(); if(!t) return;
  const obj = unpack(t);
  if(!pc) pc = newPCLocal(), attachPCHandlers();
  if(role==='host' && obj.role==='join'){ await pc.setRemoteDescription(obj.sdp); log('QR: answer applied — connecting…'); }
  else if(role==='join' && obj.role==='host'){
    await pc.setRemoteDescription(obj.sdp);
    const ans=await pc.createAnswer(); await pc.setLocalDescription(ans);
    await waitIceComplete(pc);
    const reply=pack({role,sdp:pc.localDescription});
    makeQR(reply); log('QR: reply ready — show back to Host');
  } else { alert('Role mismatch. One must be Host, the other Joiner.'); }
};

/* ================= Camera QR scan ================= */
let scanner=null;
$('#scanStart').onclick = ()=>{
  try{
    scanner = new Html5Qrcode("reader");
    scanner.start(
      { facingMode:"environment" },
      { fps:10, qrbox:220 },
      decoded=>{
        $('#qrPaste').value=decoded;
        $('#qrScan').click();
        $('#scanStop').click();
      },
      _err=>{}
    ).catch(err=>console.error('scan start error',err));
  }catch(e){console.error(e);}
};
$('#scanStop').onclick = ()=>{
  if(scanner){ scanner.stop().then(()=>scanner.clear()).catch(()=>{}); scanner=null; }
};
</script>
</body>
</html>
