<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pairing Demo — 6-Digit Cloud + QR Offline</title>
<style>
  :root{--bg:#f7f7f8;--fg:#222;--muted:#666;--ok:#1b5e20;--okbg:#e8f5e9;--warn:#795548;--warnbg:#fff8e1;--bad:#b71c1c;--badbg:#ffebee}
  *{box-sizing:border-box} body{margin:0;padding:16px;background:var(--bg);color:var(--fg);font:15px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  h1{margin:0 0 8px;font-size:18px} h2{margin:0 0 6px;font-size:16px}
  .row{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px}
  .muted{color:var(--muted);font-size:.9rem}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed} input,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
  textarea{height:120px;font:12px ui-monospace,monospace}
  .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9rem}
  .ok{background:var(--okbg);color:var(--ok)} .warn{background:var(--warnbg);color:var(--warn)} .bad{background:var(--badbg);color:var(--bad)}
  .controls button{margin:6px 8px 0 0}
  .tabs{display:flex;gap:8px;margin:8px 0} .tab{padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#fff;cursor:pointer}
  .tab.active{background:#eef} .pane{display:none} .pane.active{display:block}
  canvas{image-rendering:pixelated}
</style>
</head>
<body>
<h1>Pairing Demo — 6-Digit Cloud + QR Offline</h1>
<div class="card muted">Pick a role (Host/Joiner). Use <b>Cloud (6-digit)</b> for easy pairing, or <b>QR (offline)</b> with no internet. After pairing, use the buttons to trigger audio on the other device.</div>

<div class="row">
  <div class="card">
    <h2>Role</h2>
    <button id="roleHost">Host</button>
    <button id="roleJoin">Joiner</button>
    <span id="roleBadge" class="status warn">no role</span>
  </div>
  <div class="card">
    <h2>Status</h2>
    <div>Peer: <span id="conn" class="status warn">idle</span> &nbsp; DataChannel: <span id="dc" class="status warn">-</span></div>
    <div id="log" class="muted" style="margin-top:8px;max-height:160px;overflow:auto;white-space:pre-wrap"></div>
  </div>
</div>

<div class="card">
  <div class="tabs">
    <div class="tab active" data-pane="cloud">Cloud (6-digit)</div>
    <div class="tab" data-pane="qr">QR (offline)</div>
  </div>

  <div id="pane-cloud" class="pane active">
    <div class="row">
      <div class="card">
        <h2>Firebase</h2>
        <button id="initFb">Init Firebase</button>
        <span id="fbState" class="status warn">not ready</span>
      </div>
      <div class="card">
        <h2>Start (6-digit code)</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <label>Code:&nbsp;<input id="code" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="123456" style="width:9ch"/></label>
          <button id="startCloud">Start</button>
        </div>
        <div class="muted" style="margin-top:6px">Share the 6-digit code with your partner.</div>
      </div>
    </div>
  </div>

  <div id="pane-qr" class="pane">
    <div class="row">
      <div class="card">
        <h2>My QR</h2>
        <button id="qrMake">Create my QR</button>
        <div id="qrWrap" style="margin-top:8px"></div>
      </div>
      <div class="card">
        <h2>Scan partner QR</h2>
        <textarea id="qrPaste" placeholder="Paste partner QR text here (base64)…"></textarea>
        <button id="qrScan">Apply</button>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Actions</h2>
  <div class="controls">
    <button id="btnBeep" disabled>Beep (440 Hz)</button>
    <button id="btnChirp" disabled>Chirp</button>
    <button id="btnPing" disabled>Ping</button>
  </div>
</div>

<script type="module">
/* === Helpers === */
const $=s=>document.querySelector(s);const logEl=$('#log');
function log(...a){logEl.textContent+=a.join(' ')+"\\n";logEl.scrollTop=logEl.scrollHeight;}
function badge(el,t,c){el.textContent=t;el.className='status '+c;}
function sixDigits(x){return(''+x).replace(/\\D/g,'').slice(0,6).padStart(6,'0');}

/* Tabs */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.pane').forEach(x=>x.classList.remove('active'));
    t.classList.add('active'); $('#pane-'+t.dataset.pane).classList.add('active');};
});

/* === Role === */
let role=null;$('#roleHost').onclick=()=>{role='host';badge($('#roleBadge'),'Host','ok');};
$('#roleJoin').onclick=()=>{role='join';badge($('#roleBadge'),'Joiner','ok');};

/* === Web Audio === */
let ctx;function audio(){if(!ctx)ctx=new(AudioContext||webkitAudioContext)();}
function beep(f=440,ms=300){audio();const t=ctx.currentTime,o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=f;
g.gain.setValueAtTime(0.001,t);g.gain.exponentialRampToValueAtTime(0.2,t+0.02);g.gain.exponentialRampToValueAtTime(0.001,t+ms/1000);
o.connect(g).connect(ctx.destination);o.start(t);o.stop(t+ms/1000+0.05);}
function chirp(a=500,b=2000,ms=600){audio();const t=ctx.currentTime,o=ctx.createOscillator(),g=ctx.createGain();
o.frequency.setValueAtTime(a,t);o.frequency.linearRampToValueAtTime(b,t+ms/1000);
g.gain.setValueAtTime(0.001,t);g.gain.exponentialRampToValueAtTime(0.2,t+0.02);g.gain.exponentialRampToValueAtTime(0.001,t+ms/1000);
o.connect(g).connect(ctx.destination);o.start(t);o.stop(t+ms/1000+0.05);}
['touchstart','mousedown','keydown'].forEach(e=>window.addEventListener(e,audio,{once:true}));

/* === WebRTC === */
let pc,dc,roomUnsub=null,callerUnsub=null,calleeUnsub=null;
function newPC(localOnly){
  pc=new RTCPeerConnection(
    localOnly?{iceServers:[]}:{iceServers:[{urls:'stun:stun.l.google.com:19302'}]}
  );
  pc.onconnectionstatechange=()=>{const st=pc.connectionState;badge($('#conn'),st,st==='connected'?'ok':(st==='failed'||st==='disconnected'?'bad':'warn'));
    const on=st==='connected';['#btnBeep','#btnChirp','#btnPing'].forEach(id=>$(id).disabled=!on);};
  pc.ondatachannel=e=>{dc=e.channel;attachDC();};
}
function attachDC(){if(!dc)return;badge($('#dc'),dc.readyState,dc.readyState==='open'?'ok':'warn');
dc.onopen=()=>badge($('#dc'),dc.readyState,'ok');dc.onclose=()=>badge($('#dc'),dc.readyState,'bad');
dc.onmessage=e=>{const m=JSON.parse(e.data);if(m.type==='BEEP')beep();if(m.type==='CHIRP')chirp();log('RX',m.type);};}
function send(m){if(dc&&dc.readyState==='open')dc.send(JSON.stringify(m));}
$('#btnBeep').onclick=()=>send({type:'BEEP'});$('#btnChirp').onclick=()=>send({type:'CHIRP'});$('#btnPing').onclick=()=>send({type:'PING'});

/* === Firebase (use long-polling) === */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {
  initializeFirestore, doc, setDoc, onSnapshot, updateDoc, Timestamp,
  collection, addDoc
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBZhqD0RE0miHDHhhlDZerGIsD0S5oy4Yw",
  authDomain: "ucpairing.firebaseapp.com",
  projectId: "ucpairing",
  storageBucket: "ucpairing.firebasestorage.app",
  messagingSenderId: "663962026087",
  appId: "1:663962026087:web:a13ac7cca6fe8c1b6014c2"
};
let db;
$('#initFb').onclick=()=>{
  const app=initializeApp(firebaseConfig);
  db=initializeFirestore(app,{ experimentalAutoDetectLongPolling:true, useFetchStreams:false });
  badge($('#fbState'),'ready','ok');log('Firebase ready');
};

/* === Cloud start (6-digit + 7-day expiry + ICE candidates) === */
$('#startCloud').onclick=async()=>{
 if(!db||!role){alert('Init Firebase + pick role');return;}
 const code=sixDigits($('#code').value||Math.floor(Math.random()*1e6));
 $('#code').value=code;
 const roomRef=doc(db,'rooms',code);
 const expiresAt=Timestamp.fromMillis(Date.now()+7*24*60*60*1000); // 7 days

 roomUnsub && roomUnsub(); callerUnsub && callerUnsub(); calleeUnsub && calleeUnsub();
 newPC(false);

 if(role==='host'){
   // Host: create DC, write offer, trickle to callerCandidates; listen to calleeCandidates
   dc=pc.createDataChannel('ucktt'); attachDC();
   const callerCandidates=collection(roomRef,'callerCandidates');
   const calleeCandidates=collection(roomRef,'calleeCandidates');

   pc.onicecandidate=async e=>{ if(e.candidate) await addDoc(callerCandidates,e.candidate.toJSON()); };

   const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
   await setDoc(roomRef,{offer,expiresAt},{merge:true});
   roomUnsub=onSnapshot(roomRef,async s=>{
     const d=s.data()||{};
     if(d.answer && !pc.currentRemoteDescription){
       await pc.setRemoteDescription(d.answer); log('Got answer; connecting…');
     }
   });
   calleeUnsub=onSnapshot(calleeCandidates,snap=>{
     snap.docChanges().forEach(ch=>{ if(ch.type==='added') pc.addIceCandidate(ch.doc.data()); });
   });

 } else {
   // Joiner: wait for offer, write answer, trickle to calleeCandidates; listen to callerCandidates
   const callerCandidates=collection(roomRef,'callerCandidates');
   const calleeCandidates=collection(roomRef,'calleeCandidates');

   pc.onicecandidate=async e=>{ if(e.candidate) await addDoc(calleeCandidates,e.candidate.toJSON()); };

   roomUnsub=onSnapshot(roomRef,async s=>{
     const d=s.data()||{};
     if(d.offer && !pc.currentRemoteDescription){
       await pc.setRemoteDescription(d.offer);
       const ans=await pc.createAnswer(); await pc.setLocalDescription(ans);
       await updateDoc(roomRef,{answer:ans,expiresAt});
       log('Posted answer');
       callerUnsub=onSnapshot(callerCandidates,snap=>{
         snap.docChanges().forEach(ch=>{ if(ch.type==='added') pc.addIceCandidate(ch.doc.data()); });
       });
     }
   });
 }
};

/* === QR mode (offline, real QR generator, paste-based scanner) === */
function b64(s){return btoa(unescape(encodeURIComponent(s)));}function ub64(s){try{return decodeURIComponent(escape(atob(s)));}catch{return'';}}
$('#qrMake').onclick=async()=>{
  if(!role){alert('Pick role');return;}
  newPC(true); if(role==='host'){dc=pc.createDataChannel('ucktt'); attachDC();}
  const desc=role==='host'?await pc.createOffer():await pc.createAnswer();
  await pc.setLocalDescription(desc);
  if(pc.iceGatheringState!=='complete'){
    await new Promise(r=>pc.addEventListener('icegatheringstatechange',()=>pc.iceGatheringState==='complete'&&r()));
  }
  const packed=b64(JSON.stringify({role,sdp:pc.localDescription}));
  makeQR(packed); log('QR ready — copy/paste to partner side');
};
$('#qrScan').onclick=async()=>{
  const t=$('#qrPaste').value.trim(); if(!t) return;
  const obj=JSON.parse(ub64(t));
  if(!pc) newPC(true);
  if(role==='host' && obj.role==='join'){
    await pc.setRemoteDescription(obj.sdp); log('Answer applied — connecting…');
  } else if(role==='join' && obj.role==='host'){
    await pc.setRemoteDescription(obj.sdp);
    const ans=await pc.createAnswer(); await pc.setLocalDescription(ans);
    if(pc.iceGatheringState!=='complete'){
      await new Promise(r=>pc.addEventListener('icegatheringstatechange',()=>pc.iceGatheringState==='complete'&&r()));
    }
    const reply=b64(JSON.stringify({role,sdp:pc.localDescription}));
    makeQR(reply); log('Reply QR ready — show back to Host');
  } else {
    alert('Role mismatch. One must be Host, the other Joiner.');
  }
};

/* === QR mode (offline, debug) === */
function b64(s){return btoa(unescape(encodeURIComponent(s)));} 
function ub64(s){try{return decodeURIComponent(escape(atob(s)));}catch{return'';}}

$('#qrMake').onclick = async () => {
  if (!role) { alert('Pick role'); return; }
  console.log('[QR] QR lib present?', typeof window.QR, window.QR);
  newPC(true); 
  if (role === 'host') { dc = pc.createDataChannel('ucktt'); attachDC(); }
  const desc = role === 'host' ? await pc.createOffer() : await pc.createAnswer();
  await pc.setLocalDescription(desc);
  if (pc.iceGatheringState !== 'complete') {
    await new Promise(r => pc.addEventListener('icegatheringstatechange', () => 
      pc.iceGatheringState === 'complete' && r()));
  }
  const packed = b64(JSON.stringify({ role, sdp: pc.localDescription }));
  console.log('[QR] payload bytes(base64)=', packed.length, 'preview=', packed.slice(0,80)+'…');
  try {
    makeQR(packed);
    console.log('[QR] makeQR() called');
  } catch (e) {
    console.error('[QR] makeQR failed', e);
  }
  log('QR ready — copy/paste to partner side');
};

$('#qrScan').onclick = async () => {
  const t = $('#qrPaste').value.trim(); if (!t) return;
  const obj = JSON.parse(ub64(t));
  if (!pc) newPC(true);
  if (role === 'host' && obj.role === 'join') {
    await pc.setRemoteDescription(obj.sdp); log('Answer applied — connecting…');
  } else if (role === 'join' && obj.role === 'host') {
    await pc.setRemoteDescription(obj.sdp);
    const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
    if (pc.iceGatheringState !== 'complete') {
      await new Promise(r => pc.addEventListener('icegatheringstatechange', () => 
        pc.iceGatheringState === 'complete' && r()));
    }
    const reply = b64(JSON.stringify({ role, sdp: pc.localDescription }));
    makeQR(reply); log('Reply QR ready — show back to Host');
  } else {
    alert('Role mismatch. One must be Host, the other Joiner.');
  }
};

/* === Real QR renderer with diagnostics === */
function makeQR(text){
  if (!window.QR) {
    console.error('[QR] window.QR missing. You still have the old dummy QR block somewhere.');
    $('#qrWrap').textContent = 'QR library missing';
    return;
  }
  const qr = new QR(4, 0);      // type 4, EC level L
  qr.addData(text);
  qr.make();

  const m = qr.getModuleCount(), size = 6, pad = 10;
  const cvs = document.createElement('canvas');
  cvs.width = cvs.height = m*size + pad*2;
  const ctx = cvs.getContext('2d');

  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,cvs.width,cvs.height); 
  ctx.fillStyle = '#000';
  let dark = 0;
  for (let r=0;r<m;r++){
    for (let c=0;c<m;c++){
      if (qr.isDark(r,c)) { dark++; ctx.fillRect(pad+c*size, pad+r*size, size, size); }
    }
  }
  // Heuristic: just finders ≈ very few dark modules. Warn if suspiciously low.
  const density = dark / (m*m);
  console.log('[QR] modules', m, 'dark', dark, 'density', density.toFixed(3));
  if (density < 0.10) {
    console.warn('[QR] Very low density — looks like only finder patterns were drawn. ' +
                 'You likely still have the dummy QR function elsewhere.');
  }

  $('#qrWrap').innerHTML = '';
  $('#qrWrap').appendChild(cvs);
}

</script>
</body>
</html>
